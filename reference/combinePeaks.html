<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Aggregating and combining mass peaks data — combinePeaks • Spectra</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Aggregating and combining mass peaks data — combinePeaks"><meta name="description" content='In addition to aggregating content of spectra variables (describe in
combineSpectra()) it is also possible to aggregate and combine mass peaks
data from individual spectra within a Spectra. These combinePeaks()
function combines mass peaks within each spectrum with a difference in
their m/z values that is smaller than the maximal acceptable difference
defined by ppm and tolerance. Parameters intensityFun and mzFun
allow to define functions to aggregate the intensity and m/z values for
each such group of peaks. With weighted = TRUE (the default), the m/z
value of the combined peak is calculated using an intensity-weighted mean
and parameter mzFun is ignored. The MsCoreUtils::group() function is
used for the grouping of mass peaks. Parameter msLevel. allows to define
selected MS levels for which peaks should be combined. This function
returns a Spectra with the same number of spectra than the input object,
but with possibly combined peaks within each spectrum.
Additional peak variables (other than "mz" and "intensity") are
dropped (i.e. their values are replaced with NA) for combined peaks
unless they are constant across the combined peaks. See also
reduceSpectra() for a function to select a single representative
mass peak for each peak group.'><meta property="og:description" content='In addition to aggregating content of spectra variables (describe in
combineSpectra()) it is also possible to aggregate and combine mass peaks
data from individual spectra within a Spectra. These combinePeaks()
function combines mass peaks within each spectrum with a difference in
their m/z values that is smaller than the maximal acceptable difference
defined by ppm and tolerance. Parameters intensityFun and mzFun
allow to define functions to aggregate the intensity and m/z values for
each such group of peaks. With weighted = TRUE (the default), the m/z
value of the combined peak is calculated using an intensity-weighted mean
and parameter mzFun is ignored. The MsCoreUtils::group() function is
used for the grouping of mass peaks. Parameter msLevel. allows to define
selected MS levels for which peaks should be combined. This function
returns a Spectra with the same number of spectra than the input object,
but with possibly combined peaks within each spectrum.
Additional peak variables (other than "mz" and "intensity") are
dropped (i.e. their values are replaced with NA) for combined peaks
unless they are constant across the combined peaks. See also
reduceSpectra() for a function to select a single representative
mass peak for each peak group.'><meta property="og:image" content="https://rformassspectrometry.github.io/Spectra/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Spectra</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.19.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/Spectra.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/MsBackend.html">Creating new `MsBackend` classes</a></li>
    <li><a class="dropdown-item" href="../articles/Spectra-large-scale.html">Large-scale data handling and processing with Spectra</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RforMassSpectrometry/Spectra/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Aggregating and combining mass peaks data</h1>
      <small class="dont-index">Source: <a href="https://github.com/RforMassSpectrometry/Spectra/blob/main/R/Spectra.R" class="external-link"><code>R/Spectra.R</code></a></small>
      <div class="d-none name"><code>combinePeaks.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>In addition to aggregating content of spectra variables (describe in
<code><a href="combineSpectra.html">combineSpectra()</a></code>) it is also possible to aggregate and combine mass peaks
data from individual spectra within a <code>Spectra</code>. These <code>combinePeaks()</code>
function combines mass peaks <strong>within each spectrum</strong> with a difference in
their m/z values that is smaller than the maximal acceptable difference
defined by <code>ppm</code> and <code>tolerance</code>. Parameters <code>intensityFun</code> and <code>mzFun</code>
allow to define functions to aggregate the intensity and m/z values for
each such group of peaks. With <code>weighted = TRUE</code> (the default), the m/z
value of the combined peak is calculated using an intensity-weighted mean
and parameter <code>mzFun</code> is ignored. The <code><a href="https://rdrr.io/pkg/MsCoreUtils/man/group.html" class="external-link">MsCoreUtils::group()</a></code> function is
used for the grouping of mass peaks. Parameter <code>msLevel.</code> allows to define
selected MS levels for which peaks should be combined. This function
returns a <code>Spectra</code> with the same number of spectra than the input object,
but with possibly combined peaks within each spectrum.
Additional peak variables (other than <code>"mz"</code> and <code>"intensity"</code>) are
dropped (i.e. their values are replaced with <code>NA</code>) for combined peaks
unless they are constant across the combined peaks. See also
<code><a href="filterMsLevel.html">reduceSpectra()</a></code> for a function to select a single <em>representative</em>
mass peak for each peak group.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="co"># S4 method for class 'Spectra'</span></span>
<span><span class="fu">combinePeaks</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  tolerance <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  ppm <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  intensityFun <span class="op">=</span> <span class="fu">base</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span>,</span>
<span>  mzFun <span class="op">=</span> <span class="fu">base</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span>,</span>
<span>  weighted <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  msLevel. <span class="op">=</span> <span class="fu"><a href="spectraData.html">uniqueMsLevels</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a></dt>
<dd><p>A <code>Spectra</code> object.</p></dd>


<dt id="arg-tolerance">tolerance<a class="anchor" aria-label="anchor" href="#arg-tolerance"></a></dt>
<dd><p><code>numeric(1)</code> allowing to define a constant maximal
accepted difference between m/z values for peaks to be grouped. Default
is <code>tolerance = 0</code>.</p></dd>


<dt id="arg-ppm">ppm<a class="anchor" aria-label="anchor" href="#arg-ppm"></a></dt>
<dd><p><code>numeric(1)</code> defining a relative, m/z-dependent, maximal
accepted difference between m/z values for peaks to be grouped. Default
is <code>ppm = 20</code>.</p></dd>


<dt id="arg-intensityfun">intensityFun<a class="anchor" aria-label="anchor" href="#arg-intensityfun"></a></dt>
<dd><p>Function to aggregate intensities for all peaks in
each peak group into a single intensity value.</p></dd>


<dt id="arg-mzfun">mzFun<a class="anchor" aria-label="anchor" href="#arg-mzfun"></a></dt>
<dd><p>Function to aggregate m/z values for all mass peaks within
each peak group into a single m/z value. This parameter is ignored if
<code>weighted = TRUE</code> (the default).</p></dd>


<dt id="arg-weighted">weighted<a class="anchor" aria-label="anchor" href="#arg-weighted"></a></dt>
<dd><p><code>logical(1)</code> whether m/z values of peaks within each peak
group should be aggregated into a single m/z value using an
intensity-weighted mean. Defaults to <code>weighted = TRUE</code>.</p></dd>


<dt id="arg-mslevel-">msLevel.<a class="anchor" aria-label="anchor" href="#arg-mslevel-"></a></dt>
<dd><p><code>integer</code> defining the MS level(s) of the spectra to which
the function should be applied (defaults to all MS levels of <code>object</code>.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>ignored.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index">
<ul><li><p><code><a href="combineSpectra.html">combineSpectra()</a></code> for functions to combine or aggregate <code>Spectra</code>'s
spectra data.</p></li>
<li><p><code><a href="combinePeaksData.html">combinePeaksData()</a></code> for the function to combine the mass peaks data.</p></li>
<li><p><code><a href="filterMsLevel.html">reduceSpectra()</a></code> and similar functions to filter mass peaks data.</p></li>
<li><p><a href="Spectra.html">Spectra</a> for a general description of the <code>Spectra</code> object.</p></li>
</ul></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Sebastian Gibb, Johannes Rainer, Laurent Gatto</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Create a Spectra from mzML files and use the `MsBackendMzR` on-disk</span></span></span>
<span class="r-in"><span><span class="co">## backend.</span></span></span>
<span class="r-in"><span><span class="va">sciex_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"sciex"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">sciex</span> <span class="op">&lt;-</span> <span class="fu"><a href="Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">sciex_file</span>, backend <span class="op">=</span> <span class="fu"><a href="MsBackend.html">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Combine mass peaks per spectrum with a difference in their m/z value</span></span></span>
<span class="r-in"><span><span class="co">## that is smaller than 20 ppm. The intensity values of such peaks are</span></span></span>
<span class="r-in"><span><span class="co">## combined by summing their values, while for the m/z values the median</span></span></span>
<span class="r-in"><span><span class="co">## is reported</span></span></span>
<span class="r-in"><span><span class="va">sciex_comb</span> <span class="op">&lt;-</span> <span class="fu">combinePeaks</span><span class="op">(</span><span class="va">sciex</span>, ppm <span class="op">=</span> <span class="fl">20</span>,</span></span>
<span class="r-in"><span>    intensityFun <span class="op">=</span> <span class="va">sum</span>, mzFun <span class="op">=</span> <span class="va">median</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Comparing the number of mass peaks before and after aggregation</span></span></span>
<span class="r-in"><span><span class="fu"><a href="spectraData.html">lengths</a></span><span class="op">(</span><span class="va">sciex</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1]  578 1529 1600 1664 1417 1602</span>
<span class="r-in"><span><span class="fu"><a href="spectraData.html">lengths</a></span><span class="op">(</span><span class="va">sciex_comb</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 149 366 379 374 344 378</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Plotting the first spectrum before and after aggregation</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sciex</span><span class="op">[</span><span class="fl">2L</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sciex_comb</span><span class="op">[</span><span class="fl">2L</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="combinePeaks-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Using `reduceSpectra()` to keep for each group of mass peaks with a</span></span></span>
<span class="r-in"><span><span class="co">## difference in their m/z values &lt; 20ppm the one with the highest intensity.</span></span></span>
<span class="r-in"><span><span class="va">sciex_red</span> <span class="op">&lt;-</span> <span class="fu"><a href="filterMsLevel.html">reduceSpectra</a></span><span class="op">(</span><span class="va">sciex</span>, ppm <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Comparing the number of mass peaks before and after the operation</span></span></span>
<span class="r-in"><span><span class="fu"><a href="spectraData.html">lengths</a></span><span class="op">(</span><span class="va">sciex</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1]  578 1529 1600 1664 1417 1602</span>
<span class="r-in"><span><span class="fu"><a href="spectraData.html">lengths</a></span><span class="op">(</span><span class="va">sciex_red</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 149 366 379 374 344 378</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by RforMassSpectrometry Package Maintainer, Laurent Gatto, Johannes Rainer, Sebastian Gibb, Philippine Louail.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.9000.</p>
</div>

    </footer></div>





  </body></html>

