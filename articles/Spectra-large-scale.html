<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Spectra">
<title>Large-scale data handling and processing with Spectra • Spectra</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Large-scale data handling and processing with Spectra">
<meta property="og:description" content="Spectra">
<meta property="og:image" content="https://rformassspectrometry.github.io/Spectra/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">Spectra</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.13.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/Spectra.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/MsBackend.html">Creating new `MsBackend` classes</a>
    <a class="dropdown-item" href="../articles/Spectra-large-scale.html">Large-scale data handling and processing with Spectra</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/RforMassSpectrometry/Spectra/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Large-scale data handling and processing with Spectra</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/RforMassSpectrometry/Spectra/blob/HEAD/vignettes/Spectra-large-scale.Rmd" class="external-link"><code>vignettes/Spectra-large-scale.Rmd</code></a></small>
      <div class="d-none name"><code>Spectra-large-scale.Rmd</code></div>
    </div>

    
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><p><strong>Package</strong>: <em><a href="https://bioconductor.org/packages/3.19/Spectra" class="external-link">Spectra</a></em><br><strong>Authors</strong>: RforMassSpectrometry Package Maintainer [cre],
Laurent Gatto [aut] (<a href="https://orcid.org/0000-0002-1520-2268" class="external-link uri">https://orcid.org/0000-0002-1520-2268</a>), Johannes Rainer
[aut] (<a href="https://orcid.org/0000-0002-6977-7147" class="external-link uri">https://orcid.org/0000-0002-6977-7147</a>), Sebastian Gibb
[aut] (<a href="https://orcid.org/0000-0001-7406-4443" class="external-link uri">https://orcid.org/0000-0001-7406-4443</a>), Philippine
Louail [aut] (<a href="https://orcid.org/0009-0007-5429-6846" class="external-link uri">https://orcid.org/0009-0007-5429-6846</a>), Jan Stanstrup
[ctb] (<a href="https://orcid.org/0000-0003-0541-7369" class="external-link uri">https://orcid.org/0000-0003-0541-7369</a>), Nir Shahaf
[ctb], Mar Garcia-Aloy [ctb] (<a href="https://orcid.org/0000-0002-1330-6610" class="external-link uri">https://orcid.org/0000-0002-1330-6610</a>)<br><strong>Last modified:</strong> 2024-03-01 13:18:23.983849<br><strong>Compiled</strong>: Fri Mar 1 13:42:48 2024</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <em><a href="https://bioconductor.org/packages/3.19/Spectra" class="external-link">Spectra</a></em>
package supports handling and processing of also very large mass
spectrometry (MS) data sets. Through dedicated backends, that only load
MS data when requested/needed, the memory demand can be minimized.
Examples for such backends are the <code>MsBackendMzR</code> and the
<code>MsBackendOfflineSql</code> (defined in the <em><a href="https://bioconductor.org/packages/3.19/MsBackendSql" class="external-link">MsBackendSql</a></em>
package). In addition, <code>Spectra</code> supports chunk-wise data
processing, hence only parts of the data are loaded into memory and
processed at a time. In this document we provide information on how
large scale data can be best processed with the <em>Spectra</em>
package.</p>
</div>
<div class="section level2">
<h2 id="memory-requirements-of-different-data-representations">Memory requirements of different data representations<a class="anchor" aria-label="anchor" href="#memory-requirements-of-different-data-representations"></a>
</h2>
<p>The <em>Spectra</em> package separates functionality to process and
analyze MS data (implemented for the <code>Spectra</code> class) from
the code that defines how and where the MS data is stored. For the
latter, different implementations of the <code>MsBackend</code> class
are available, that either are optimized for performance (such as the
<code>MsBackendMemory</code> and <code>MsBackendDataFrame</code>) or for
low memory requirement (such as the <code>MsBackendMzR</code>, or the
<code>MsBackendOfflineSql</code> implemented in the <em><a href="https://bioconductor.org/packages/3.19/MsBackendSql" class="external-link">MsBackendSql</a></em>
package, that through the smallest possible memory footprint enables
also the analysis of very large data sets). Below we load MS data from 4
test files into a <code>Spectra</code> using a <code>MsBackendMzR</code>
backend.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Define the file names from which to import the data</span></span>
<span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"TripleTOF-SWATH"</span>, <span class="st">"PestMix1_DDA.mzML"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"TripleTOF-SWATH"</span>, <span class="st">"PestMix1_SWATH.mzML"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"sciex"</span>, <span class="st">"20171016_POOL_POS_1_105-134.mzML"</span>,</span>
<span>                package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"sciex"</span>, <span class="st">"20171016_POOL_POS_3_105-134.mzML"</span>,</span>
<span>                package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Creating a Spectra object representing the MS data</span></span>
<span><span class="va">sps_mzr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, source <span class="op">=</span> <span class="fu"><a href="../reference/MsBackend.html">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps_mzr</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 18463 spectra in a MsBackendMzR backend:</span></span>
<span><span class="co">##         msLevel     rtime scanIndex</span></span>
<span><span class="co">##       &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1             1     0.231         1</span></span>
<span><span class="co">## 2             1     0.351         2</span></span>
<span><span class="co">## 3             1     0.471         3</span></span>
<span><span class="co">## 4             1     0.591         4</span></span>
<span><span class="co">## 5             1     0.711         5</span></span>
<span><span class="co">## ...         ...       ...       ...</span></span>
<span><span class="co">## 18459         1   258.636       927</span></span>
<span><span class="co">## 18460         1   258.915       928</span></span>
<span><span class="co">## 18461         1   259.194       929</span></span>
<span><span class="co">## 18462         1   259.473       930</span></span>
<span><span class="co">## 18463         1   259.752       931</span></span>
<span><span class="co">##  ... 33 more variables/columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## file(s):</span></span>
<span><span class="co">## PestMix1_DDA.mzML</span></span>
<span><span class="co">## PestMix1_SWATH.mzML</span></span>
<span><span class="co">## 20171016_POOL_POS_1_105-134.mzML</span></span>
<span><span class="co">##  ... 1 more files</span></span></code></pre>
<p>The resulting <code>Spectra</code> uses a <code>MsBackendMzR</code>
for data representation. This backend does only load general spectra
data into memory while the <em>full</em> MS data (i.e., the <em>m/z</em>
and intensity values of the individual mass peaks) is only loaded when
requested or needed. In contrast to an <em>in-memory</em> backend, the
memory footprint of this backend is thus lower.</p>
<p>Below we create a <code>Spectra</code> that keeps the full data in
memory by changing the backend to a <code>MsBackendMemory</code> backend
and compare the sizes of both objects.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_mem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/backendInitialize.html" class="external-link">setBackend</a></span><span class="op">(</span><span class="va">sps_mzr</span>, <span class="fu"><a href="../reference/MsBackend.html">MsBackendMemory</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_mzr</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 5.2 Mb</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_mem</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"MB"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 140.1 Mb</span></span></code></pre>
<p>Keeping the full data in memory requires thus considerably more
memory.</p>
<p>We next disable parallel processing for <em>Spectra</em> to allow an
unbiased estimation of memory usage.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Disable parallel processing globally</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">register</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/SerialParam-class.html" class="external-link">SerialParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="chunk-wise-and-parallel-processing">Chunk-wise and parallel processing<a class="anchor" aria-label="anchor" href="#chunk-wise-and-parallel-processing"></a>
</h2>
<p>Operations on peaks data are the most time and memory demanding
tasks. These generally apply a function to, or modify the <em>m/z</em>
and/or intensity values. Among these functions are for example functions
that filter, remove or combine mass peaks (such as
<code>filterMzRange</code>, <code>filterIntensity</code> or
<code>combinePeaks</code>) or functions that perform calculations on the
peaks data (such as <code>bin</code> or <code>pickPeaks</code>) or also
functions that provide information on, or summarize spectra (such as
<code>lengths</code> or <code>ionCount</code>). For all these functions,
the peaks data needs to be present in memory and on-disk backends, such
as the <code>MsBackendMzR</code>, need thus to first import the data
from their data storage. However, loading the full peaks data at once
into memory might not be possible for large data sets. Loading and
processing the data in smaller chunks would however reduce the memory
demand and hence allow to process also such data sets. For the
<code>MsBackendMzR</code> and <code>MsBackendHdf5Peaks</code> backends
the data is automatically split and processed by the data storage files.
For all other backends chunk-wise processing can be enabled by defining
the <code>processingChunkSize</code> of a <code>Spectra</code>, i.e. the
number of spectra for which peaks data should be loaded and processed in
each iteration. The <code>processingChunkFactor</code> function can be
used to evaluate how the data will be split. Below we use this function
to evaluate how chunk-wise processing would be performed with the two
<code>Spectra</code> objects.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/processingChunkSize.html">processingChunkFactor</a></span><span class="op">(</span><span class="va">sps_mem</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## factor()</span></span>
<span><span class="co">## Levels:</span></span></code></pre>
<p>For the <code>Spectra</code> with the in-memory backend an empty
<code><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor()</a></code> is returned, thus, no chunk-wise processing will
be performed. We next evaluate whether the <code>Spectra</code> with the
<code>MsBackendMzR</code> on-disk backend would use chunk-wise
processing.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/processingChunkSize.html">processingChunkFactor</a></span><span class="op">(</span><span class="va">sps_mzr</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##      /__w/_temp/Library/msdata/TripleTOF-SWATH/PestMix1_DDA.mzML </span></span>
<span><span class="co">##                                                             7602 </span></span>
<span><span class="co">##    /__w/_temp/Library/msdata/TripleTOF-SWATH/PestMix1_SWATH.mzML </span></span>
<span><span class="co">##                                                             8999 </span></span>
<span><span class="co">## /__w/_temp/Library/msdata/sciex/20171016_POOL_POS_1_105-134.mzML </span></span>
<span><span class="co">##                                                              931 </span></span>
<span><span class="co">## /__w/_temp/Library/msdata/sciex/20171016_POOL_POS_3_105-134.mzML </span></span>
<span><span class="co">##                                                              931</span></span></code></pre>
<p>The data would thus be split and processed by the original file, from
which the data is imported. We next specifically define the chunk-size
for both <code>Spectra</code> with the <code>processingChunkSize</code>
function.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/processingChunkSize.html">processingChunkSize</a></span><span class="op">(</span><span class="va">sps_mem</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">3000</span></span>
<span><span class="fu"><a href="../reference/processingChunkSize.html">processingChunkFactor</a></span><span class="op">(</span><span class="va">sps_mem</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##    1    2    3    4    5    6    7 </span></span>
<span><span class="co">## 3000 3000 3000 3000 3000 3000  463</span></span></code></pre>
<p>After setting the chunk size, also the <code>Spectra</code> with the
in-memory backend would use chunk-wise processing. We repeat with the
other <code>Spectra</code> object:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/processingChunkSize.html">processingChunkSize</a></span><span class="op">(</span><span class="va">sps_mzr</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">3000</span></span>
<span><span class="fu"><a href="../reference/processingChunkSize.html">processingChunkFactor</a></span><span class="op">(</span><span class="va">sps_mzr</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##    1    2    3    4    5    6    7 </span></span>
<span><span class="co">## 3000 3000 3000 3000 3000 3000  463</span></span></code></pre>
<p>The <code>Spectra</code> with the <code>MsBackendMzR</code> backend
would now split the data in about equally sized arbitrary chunks and no
longer by original data file. Setting <code>processingChunkSize</code>
thus overrides any splitting suggested by the backend.</p>
<p>After having set a <code>processingChunkSize</code>, any operation
involving peaks data will by default be performed in a chunk-wise
manner. Thus, calling <code>ionCount</code> on our <code>Spectra</code>
will now split the data in chunks of 3000 spectra and sum the
intensities (per spectrum) chunk by chunk.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">ionCount</a></span><span class="op">(</span><span class="va">sps_mem</span><span class="op">)</span></span></code></pre></div>
<p>While chunk-wise processing reduces the memory demand of operations,
the splitting and merging of the data and results can negatively impact
performance. Thus, small data sets or <code>Spectra</code> with
in-memory backends will generally not benefit from this type of
processing. For computationally intense operation on the other hand,
chunk-wise processing has the advantage, that chunks can (and will) be
processed in parallel (depending on the parallel processing setup).</p>
<p>Note that this chunk-wise processing only affects functions that
involve actual peak data. Subset operations that only reduce the number
of spectra (such as <code>filterRt</code> or <code>[</code>) bypass this
mechanism and are applied immediately to the data.</p>
<p>For an evaluation of chunk-wise processing see also this <a href="https://github.com/rformassspectrometry/Spectra/issues/304#issuecomment-1825699576" class="external-link">issue</a>
on the <em>Spectra</em> github repository.</p>
</div>
<div class="section level2">
<h2 id="notes-and-suggestions-for-parallel-or-chunk-wise-processing">Notes and suggestions for parallel or chunk-wise processing<a class="anchor" aria-label="anchor" href="#notes-and-suggestions-for-parallel-or-chunk-wise-processing"></a>
</h2>
<ul>
<li><p>Estimating memory usage in R tends to be difficult, but for MS
data sets with more than about 100 samples or whenever processing tends
to take longer than expected it is suggested to enable chunk-wise
processing (if not already used, as with
<code>MsBackendMzR</code>).</p></li>
<li><p><code>Spectra</code> uses the <em><a href="https://bioconductor.org/packages/3.19/BiocParallel" class="external-link">BiocParallel</a></em>
package for parallel processing. The parallel processing setup can be
configured globally by <em>registering</em> the preferred setup using
the <code>register</code> function (e.g.
<code>register(SnowParam(4))</code> to use socket-based parallel
processing on Windows using 4 different R processes). Parallel
processing can be disabled by setting
<code>register(SerialParam())</code>.</p></li>
<li><p>Chunk-wise processing will by default run in parallel, depending
on the configured parallel processing setup.</p></li>
<li><p>Parallel processing (and also chunk-wise processing) have a
computational overhead, because the data needs to be split and merged.
Thus, for some operations or data sets avoiding this mechanism can be
more efficient (e.g. for in-memory backends or small data
sets).</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="spectra-functions-supporting-or-using-parallel-processing">
<code>Spectra</code> functions supporting or using parallel
processing<a class="anchor" aria-label="anchor" href="#spectra-functions-supporting-or-using-parallel-processing"></a>
</h2>
<p>Some functions allow to configure parallel processing using a
dedicated parameter that allows to define how to split the data for
parallel (or chunk-wise) processing. These functions are:</p>
<ul>
<li>
<code>applyProcessing</code>: parameter <code>f</code> (defaults to
<code>processingChunkFactor(object)</code>) can be used to define how to
split and process the data in parallel.</li>
<li>
<code>combineSpectra</code>: parameter <code>p</code> (defaults to
<code>x$dataStorage</code>) defines how the data should be split and
processed in parallel.</li>
<li>
<code>estimatePrecursorIntensity</code>: parameter <code>f</code>
(defaults to <code>dataOrigin(x)</code>) defines the splitting and
processing. This should represent the original data files the spectra
data derives from.</li>
<li>
<code>intensity</code>: parameter <code>f</code> (defaults to
<code>processingChunkFactor(object)</code>) defines if and how the data
should be split for parallel processing.</li>
<li>
<code>mz</code>: parameter <code>f</code> (defaults to
<code>processingChunkFactor(object)</code>) defines if and how the data
should be split for parallel processing.</li>
<li>
<code>peaksData</code>: parameter <code>f</code> (defaults to
<code>processingChunkFactor(object)</code>) defines if and how the data
should be split for parallel processing.</li>
<li>
<code>setBackend</code>: parameter <code>f</code> (defaults to
<code>processingChunkFactor(object)</code>) defines if and how the data
should be split for parallel processing.</li>
</ul>
<p>Functions that perform chunk-wise (parallel) processing
<em>natively</em>, i.e., based on the
<code>processingChunkFactor</code>:</p>
<ul>
<li>
<code>containsMz</code>.</li>
<li>
<code>containsNeutralLoss</code>.</li>
<li>
<code>ionCount</code>.</li>
<li>
<code>isCentroided</code>.</li>
<li>
<code>isEmpty</code>.</li>
</ul>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R Under development (unstable) (2024-02-21 r85967)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">## Running under: Ubuntu 22.04.3 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span><span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] Spectra_1.13.5      ProtGenerics_1.35.3 BiocParallel_1.37.0</span></span>
<span><span class="co">## [4] S4Vectors_0.41.3    BiocGenerics_0.49.1 BiocStyle_2.31.0   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] jsonlite_1.8.8         compiler_4.4.0         BiocManager_1.30.22   </span></span>
<span><span class="co">##  [4] Rcpp_1.0.12            Biobase_2.63.0         stringr_1.5.1         </span></span>
<span><span class="co">##  [7] parallel_4.4.0         cluster_2.1.6          jquerylib_0.1.4       </span></span>
<span><span class="co">## [10] systemfonts_1.0.5      IRanges_2.37.1         textshaping_0.3.7     </span></span>
<span><span class="co">## [13] yaml_2.3.8             fastmap_1.1.1          R6_2.5.1              </span></span>
<span><span class="co">## [16] knitr_1.45             MASS_7.3-60.2          bookdown_0.37         </span></span>
<span><span class="co">## [19] desc_1.4.3             bslib_0.6.1            rlang_1.1.3           </span></span>
<span><span class="co">## [22] cachem_1.0.8           stringi_1.8.3          xfun_0.42             </span></span>
<span><span class="co">## [25] MsCoreUtils_1.15.4     fs_1.6.3               sass_0.4.8            </span></span>
<span><span class="co">## [28] memoise_2.0.1          cli_3.6.2              pkgdown_2.0.7.9000    </span></span>
<span><span class="co">## [31] magrittr_2.0.3         ncdf4_1.22             digest_0.6.34         </span></span>
<span><span class="co">## [34] mzR_2.37.2             MetaboCoreUtils_1.11.2 clue_0.3-65           </span></span>
<span><span class="co">## [37] lifecycle_1.0.4        vctrs_0.6.5            evaluate_0.23         </span></span>
<span><span class="co">## [40] glue_1.7.0             codetools_0.2-19       ragg_1.2.7            </span></span>
<span><span class="co">## [43] rmarkdown_2.25         purrr_1.0.2            tools_4.4.0           </span></span>
<span><span class="co">## [46] htmltools_0.5.7</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by RforMassSpectrometry Package Maintainer, Laurent Gatto, Johannes Rainer, Sebastian Gibb, Philippine Louail.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
