<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Description and usage of Spectra objects • Spectra</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Description and usage of Spectra objects">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Spectra</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.19.7</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/Spectra.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/MsBackend.html">Creating new `MsBackend` classes</a></li>
    <li><a class="dropdown-item" href="../articles/Spectra-large-scale.html">Large-scale data handling and processing with Spectra</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RforMassSpectrometry/Spectra/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Description and usage of Spectra objects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/RforMassSpectrometry/Spectra/blob/main/vignettes/Spectra.Rmd" class="external-link"><code>vignettes/Spectra.Rmd</code></a></small>
      <div class="d-none name"><code>Spectra.Rmd</code></div>
    </div>

    
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><p><strong>Package</strong>: <em><a href="https://bioconductor.org/packages/3.22/Spectra" class="external-link">Spectra</a></em><br><strong>Authors</strong>: RforMassSpectrometry Package Maintainer [cre],
Laurent Gatto [aut] (ORCID: <a href="https://orcid.org/0000-0002-1520-2268" class="external-link uri">https://orcid.org/0000-0002-1520-2268</a>), Johannes Rainer
[aut] (ORCID: <a href="https://orcid.org/0000-0002-6977-7147" class="external-link uri">https://orcid.org/0000-0002-6977-7147</a>), Sebastian Gibb
[aut] (ORCID: <a href="https://orcid.org/0000-0001-7406-4443" class="external-link uri">https://orcid.org/0000-0001-7406-4443</a>), Philippine
Louail [aut] (ORCID: <a href="https://orcid.org/0009-0007-5429-6846" class="external-link uri">https://orcid.org/0009-0007-5429-6846</a>), Jan Stanstrup
[ctb] (ORCID: <a href="https://orcid.org/0000-0003-0541-7369" class="external-link uri">https://orcid.org/0000-0003-0541-7369</a>), Nir Shahaf
[ctb], Mar Garcia-Aloy [ctb] (ORCID: <a href="https://orcid.org/0000-0002-1330-6610" class="external-link uri">https://orcid.org/0000-0002-1330-6610</a>), Guillaume
Deflandre [ctb] (ORCID: <a href="https://orcid.org/0009-0008-1257-2416" class="external-link uri">https://orcid.org/0009-0008-1257-2416</a>), Ahlam Mentag
[ctb] (ORCID: <a href="https://orcid.org/0009-0008-5438-7067" class="external-link uri">https://orcid.org/0009-0008-5438-7067</a>)<br><strong>Last modified:</strong> 2025-08-28 08:11:58.639989<br><strong>Compiled</strong>: Thu Aug 28 08:26:06 2025</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <em><a href="https://bioconductor.org/packages/3.22/Spectra" class="external-link">Spectra</a></em>
package provides a scalable and flexible infrastructure to represent,
retrieve and handle mass spectrometry (MS) data. The
<code>Spectra</code> object provides the user with a single standardized
interface to access and manipulate MS data while supporting, through the
concept of exchangeable <em>backends</em>, a large variety of different
ways to store and retrieve mass spectrometry data. Such backends range
from mzML/mzXML/CDF files, simple flat files, or database systems.</p>
<p>This vignette provides general examples and descriptions for the
<em>Spectra</em> package. Additional information and tutorials are
available, such as <a href="https://jorainer.github.io/SpectraTutorials/" class="external-link">SpectraTutorials</a>,
<a href="https://jorainer.github.io/MetaboAnnotationTutorials" class="external-link">MetaboAnnotationTutorials</a>,
or also in <span class="citation">(Rainer et al. 2022)</span>. For
information on how to handle and (parallel) process large-scale data
sets see the <em>Large-scale data handling and processing with
Spectra</em> vignette.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>The package can be installed with the <em>BiocManager</em> package.
To install <em>BiocManager</em> use
<code>install.packages("BiocManager")</code> and, after that,
<code>BiocManager::install("Spectra")</code> to install
<em>Spectra</em>.</p>
</div>
<div class="section level2">
<h2 id="general-usage">General usage<a class="anchor" aria-label="anchor" href="#general-usage"></a>
</h2>
<p>Mass spectrometry data in <code>Spectra</code> objects can be thought
of as a list of individual spectra, with each spectrum having a set of
variables associated with it. Besides <em>core</em> spectra variables
(such as MS level or retention time) an arbitrary number of optional
variables can be assigned to a spectrum. The core spectra variables all
have their own accessor method and it is guaranteed that a value is
returned by it (or <code>NA</code> if the information is not available).
The core variables and their data type are (alphabetically ordered):</p>
<ul>
<li>
<em>acquisitionNum</em> <code>integer(1)</code>: the index of
acquisition of a spectrum during a MS run.</li>
<li>
<em>centroided</em> <code>logical(1)</code>: whether the spectrum is
in profile or centroid mode.</li>
<li>
<em>collisionEnergy</em> <code>numeric(1)</code>: collision energy
used to create an MSn spectrum.</li>
<li>
<em>dataOrigin</em> <code>character(1)</code>: the <em>origin</em>
of the spectrum’s data, e.g. the mzML file from which it was read.</li>
<li>
<em>dataStorage</em> <code>character(1)</code>: the (current)
storage location of the spectrum data. This value depends on the backend
used to handle and provide the data. For an <em>in-memory</em> backend
like the <code>MsBackendDataFrame</code> this will be
<code>"&lt;memory&gt;"</code>, for an on-disk backend such as the
<code>MsBackendHdf5Peaks</code> it will be the name of the HDF5 file
where the spectrum’s peak data is stored.</li>
<li>
<em>intensity</em> <code>numeric</code>: intensity values for the
spectrum’s peaks.</li>
<li>
<em>isolationWindowLowerMz</em> <code>numeric(1)</code>: lower m/z
for the isolation window in which the (MSn) spectrum was measured.</li>
<li>
<em>isolationWindowTargetMz</em> <code>numeric(1)</code>: the target
m/z for the isolation window in which the (MSn) spectrum was
measured.</li>
<li>
<em>isolationWindowUpperMz</em> <code>numeric(1)</code>: upper m/z
for the isolation window in which the (MSn) spectrum was measured.</li>
<li>
<em>msLevel</em> <code>integer(1)</code>: the MS level of the
spectrum.</li>
<li>
<em>mz</em> <code>numeric</code>: the m/z values for the spectrum’s
peaks.</li>
<li>
<em>polarity</em> <code>integer(1)</code>: the polarity of the
spectrum (<code>0</code> and <code>1</code> representing negative and
positive polarity, respectively).</li>
<li>
<em>precScanNum</em> <code>integer(1)</code>: the scan (acquisition)
number of the precursor for an MSn spectrum.</li>
<li>
<em>precursorCharge</em> <code>integer(1)</code>: the charge of the
precursor of an MSn spectrum.</li>
<li>
<em>precursorIntensity</em> <code>numeric(1)</code>: the intensity
of the precursor of an MSn spectrum.</li>
<li>
<em>precursorMz</em> <code>numeric(1)</code>: the m/z of the
precursor of an MSn spectrum.</li>
<li>
<em>rtime</em> <code>numeric(1)</code>: the retention time of a
spectrum.</li>
<li>
<em>scanIndex</em> <code>integer(1)</code>: the index of a spectrum
within a (raw) file.</li>
<li>
<em>smoothed</em> <code>logical(1)</code>: whether the spectrum was
smoothed.</li>
</ul>
<p>For details on the individual variables and their getter/setter
function see the help for <code>Spectra</code> (<code><a href="../reference/Spectra.html">?Spectra</a></code>).
Also note that these variables are suggested, but not required to
characterize a spectrum. Also, some only make sense for MSn, but not for
MS1 spectra.</p>
<div class="section level3">
<h3 id="creating-spectra-objects">Creating <code>Spectra</code> objects<a class="anchor" aria-label="anchor" href="#creating-spectra-objects"></a>
</h3>
<p>The simplest way to create a <code>Spectra</code> object is by
defining a <code>DataFrame</code> with the corresponding spectra data
(using the corresponding spectra variable names as column names) and
passing that to the <code>Spectra</code> constructor function. Below we
create such an object for a set of 3 spectra providing their MS level,
olarity but also additional annotations such as their ID in <a href="http://hmdb.ca" class="external-link">HMDB</a> (human metabolome database) and their
name. The m/z and intensity values for each spectrum have to be provided
as a <code>list</code> of <code>numeric</code> values.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">spd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/DataFrame-class.html" class="external-link">DataFrame</a></span><span class="op">(</span></span>
<span>    msLevel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>,</span>
<span>    polarity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,</span>
<span>    id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HMDB0000001"</span>, <span class="st">"HMDB0000001"</span>, <span class="st">"HMDB0001847"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1-Methylhistidine"</span>, <span class="st">"1-Methylhistidine"</span>, <span class="st">"Caffeine"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Assign m/z and intensity values.</span></span>
<span><span class="va">spd</span><span class="op">$</span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">109.2</span>, <span class="fl">124.2</span>, <span class="fl">124.5</span>, <span class="fl">170.16</span>, <span class="fl">170.52</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">83.1</span>, <span class="fl">96.12</span>, <span class="fl">97.14</span>, <span class="fl">109.14</span>, <span class="fl">124.08</span>, <span class="fl">125.1</span>, <span class="fl">170.16</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">56.0494</span>, <span class="fl">69.0447</span>, <span class="fl">83.0603</span>, <span class="fl">109.0395</span>, <span class="fl">110.0712</span>,</span>
<span>      <span class="fl">111.0551</span>, <span class="fl">123.0429</span>, <span class="fl">138.0662</span>, <span class="fl">195.0876</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">spd</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.407</span>, <span class="fl">47.494</span>, <span class="fl">3.094</span>, <span class="fl">100.0</span>, <span class="fl">13.240</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6.685</span>, <span class="fl">4.381</span>, <span class="fl">3.022</span>, <span class="fl">16.708</span>, <span class="fl">100.0</span>, <span class="fl">4.565</span>, <span class="fl">40.643</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.459</span>, <span class="fl">2.585</span>, <span class="fl">2.446</span>, <span class="fl">0.508</span>, <span class="fl">8.968</span>, <span class="fl">0.524</span>, <span class="fl">0.974</span>, <span class="fl">100.0</span>, <span class="fl">40.994</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">spd</span><span class="op">)</span></span>
<span><span class="va">sps</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 3 spectra in a MsBackendMemory backend:</span></span>
<span><span class="co">##     msLevel     rtime scanIndex</span></span>
<span><span class="co">##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1         2        NA        NA</span></span>
<span><span class="co">## 2         2        NA        NA</span></span>
<span><span class="co">## 3         2        NA        NA</span></span>
<span><span class="co">##  ... 18 more variables/columns.</span></span></code></pre>
<p>Alternatively, it is possible to import spectra data from mass
spectrometry raw files in mzML/mzXML or CDF format. Below we create a
<code>Spectra</code> object from two mzML files and define to use a
<code>MsBackendMzR</code> backend to <em>store</em> the data (note that
this requires the <em><a href="https://bioconductor.org/packages/3.22/mzR" class="external-link">mzR</a></em> package
to be installed). This backend, specifically designed for raw MS data,
keeps only a subset of spectra variables in memory while reading the m/z
and intensity values from the original data files only on demand. See
section <a href="#backends">Backends</a> for more details on backends
and their properties.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"sciex"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">sps_sciex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, source <span class="op">=</span> <span class="fu"><a href="../reference/MsBackend.html">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps_sciex</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 1862 spectra in a MsBackendMzR backend:</span></span>
<span><span class="co">##        msLevel     rtime scanIndex</span></span>
<span><span class="co">##      &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1            1     0.280         1</span></span>
<span><span class="co">## 2            1     0.559         2</span></span>
<span><span class="co">## 3            1     0.838         3</span></span>
<span><span class="co">## 4            1     1.117         4</span></span>
<span><span class="co">## 5            1     1.396         5</span></span>
<span><span class="co">## ...        ...       ...       ...</span></span>
<span><span class="co">## 1858         1   258.636       927</span></span>
<span><span class="co">## 1859         1   258.915       928</span></span>
<span><span class="co">## 1860         1   259.194       929</span></span>
<span><span class="co">## 1861         1   259.473       930</span></span>
<span><span class="co">## 1862         1   259.752       931</span></span>
<span><span class="co">##  ... 34 more variables/columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## file(s):</span></span>
<span><span class="co">## 20171016_POOL_POS_1_105-134.mzML</span></span>
<span><span class="co">## 20171016_POOL_POS_3_105-134.mzML</span></span></code></pre>
<p>The <code>Spectra</code> object <code>sps_sciex</code> allows now to
access spectra data from 1862 MS1 spectra and uses
<code>MsBackendMzR</code> as backend (the <code>Spectra</code> object
<code>sps</code> created in the previous code block uses the default
<code>MsBackendMemory</code>).</p>
</div>
<div class="section level3">
<h3 id="accessing-spectrum-data">Accessing spectrum data<a class="anchor" aria-label="anchor" href="#accessing-spectrum-data"></a>
</h3>
<p>As detailed above <code>Spectra</code> objects can contain an
arbitrary number of properties of a spectrum (so called <em>spectra
variables</em>). The available variables can be listed with the
<code><a href="../reference/spectraData.html">spectraVariables()</a></code> method:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">spectraVariables</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                 "rtime"                  </span></span>
<span><span class="co">##  [3] "acquisitionNum"          "scanIndex"              </span></span>
<span><span class="co">##  [5] "dataStorage"             "dataOrigin"             </span></span>
<span><span class="co">##  [7] "centroided"              "smoothed"               </span></span>
<span><span class="co">##  [9] "polarity"                "precScanNum"            </span></span>
<span><span class="co">## [11] "precursorMz"             "precursorIntensity"     </span></span>
<span><span class="co">## [13] "precursorCharge"         "collisionEnergy"        </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"</span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"  "id"                     </span></span>
<span><span class="co">## [19] "name"</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">spectraVariables</a></span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                  "rtime"                   </span></span>
<span><span class="co">##  [3] "acquisitionNum"           "scanIndex"               </span></span>
<span><span class="co">##  [5] "dataStorage"              "dataOrigin"              </span></span>
<span><span class="co">##  [7] "centroided"               "smoothed"                </span></span>
<span><span class="co">##  [9] "polarity"                 "precScanNum"             </span></span>
<span><span class="co">## [11] "precursorMz"              "precursorIntensity"      </span></span>
<span><span class="co">## [13] "precursorCharge"          "collisionEnergy"         </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"   "isolationWindowTargetMz" </span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"   "peaksCount"              </span></span>
<span><span class="co">## [19] "totIonCurrent"            "basePeakMZ"              </span></span>
<span><span class="co">## [21] "basePeakIntensity"        "ionisationEnergy"        </span></span>
<span><span class="co">## [23] "lowMZ"                    "highMZ"                  </span></span>
<span><span class="co">## [25] "mergedScan"               "mergedResultScanNum"     </span></span>
<span><span class="co">## [27] "mergedResultStartScanNum" "mergedResultEndScanNum"  </span></span>
<span><span class="co">## [29] "injectionTime"            "filterString"            </span></span>
<span><span class="co">## [31] "spectrumId"               "ionMobilityDriftTime"    </span></span>
<span><span class="co">## [33] "scanWindowLowerLimit"     "scanWindowUpperLimit"    </span></span>
<span><span class="co">## [35] "electronBeamEnergy"</span></span></code></pre>
<p>The two <code>Spectra</code> contain a different set of variables:
besides <code>"msLevel"</code>, <code>"polarity"</code>,
<code>"id"</code> and <code>"name"</code>, that were specified for the
<code>Spectra</code> object <code>sps</code>, it contains more variables
such as <code>"rtime"</code>, <code>"acquisitionNum"</code> and
<code>"scanIndex"</code>. These are part of the <em>core variables</em>
defining a spectrum and for all of these accessor methods exist. Below
we use <code><a href="../reference/spectraData.html">msLevel()</a></code> and <code><a href="../reference/spectraData.html">rtime()</a></code> to access the MS
levels and retention times for the spectra in <code>sps</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">msLevel</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2 2 2</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">rtime</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] NA NA NA</span></span></code></pre>
<p>We did not specify retention times for the spectra in
<code>sps</code> thus <code>NA</code> is returned for them. The
<code>Spectra</code> object <code>sps_sciex</code> contains many more
variables, all of which were extracted from the mzML files. Below we
extract the retention times for the first spectra in the object.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/spectraData.html">rtime</a></span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.280 0.559 0.838 1.117 1.396 1.675</span></span></code></pre>
<p>Note that in addition to the accessor functions it is also possible
to use <code>$</code> to extract a specific spectra variable. To extract
the name of the compounds in <code>sps</code> we can use
<code>sps$name</code>, or, to extract the MS levels
<code>sps$msLevel</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span><span class="op">$</span><span class="va">name</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "1-Methylhistidine" "1-Methylhistidine" "Caffeine"</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span><span class="op">$</span><span class="va">msLevel</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2 2 2</span></span></code></pre>
<p>We could also replace specific spectra variables using either the
dedicated method or <code>$</code>. Below we specify that all spectra in
<code>sps</code> represent centroided data.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span><span class="op">$</span><span class="va">centroided</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span></span>
<span><span class="fu"><a href="../reference/spectraData.html">centroided</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE TRUE TRUE</span></span></code></pre>
<p>The <code>$</code> operator can also be used to add arbitrary new
spectra variables to a <code>Spectra</code> object. Below we add the
SPLASH key to each of the spectra.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span><span class="op">$</span><span class="va">splash</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"splash10-00di-0900000000-037d24a7d65676b7e356"</span>,</span>
<span>    <span class="st">"splash10-00di-0900000000-03e99316bd6c098f5d11"</span>,</span>
<span>    <span class="st">"splash10-000i-0900000000-9af60e39c843cb715435"</span><span class="op">)</span></span></code></pre></div>
<p>This new spectra variable will now be listed as an additional
variable in the result of the <code><a href="../reference/spectraData.html">spectraVariables()</a></code> function
and we can directly access its content with <code>sps$splash</code>.</p>
<p>Each spectrum can have a different number of mass peaks, each
consisting of a mass-to-charge (m/z) and associated intensity value.
These can be extracted with the <code><a href="../reference/spectraData.html">mz()</a></code> or
<code><a href="../reference/spectraData.html">intensity()</a></code> functions, each of which return a
<code>list</code> of <code>numeric</code> values.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">mz</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 3</span></span>
<span><span class="co">## [[1]] 109.2 124.2 124.5 170.16 170.52</span></span>
<span><span class="co">## [[2]] 83.1 96.12 97.14 109.14 124.08 125.1 170.16</span></span>
<span><span class="co">## [[3]] 56.0494 69.0447 83.0603 109.0395 110.0712 111.0551 123.0429 138.0662 195.0876</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">intensity</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 3</span></span>
<span><span class="co">## [[1]] 3.407 47.494 3.094 100 13.24</span></span>
<span><span class="co">## [[2]] 6.685 4.381 3.022 16.708 100 4.565 40.643</span></span>
<span><span class="co">## [[3]] 0.459 2.585 2.446 0.508 8.968 0.524 0.974 100 40.994</span></span></code></pre>
<p>Peak data can also be extracted with the <code><a href="../reference/spectraData.html">peaksData()</a></code>
function that returns a list of numerical matrices with <em>peak
variables</em> such as m/z and intensity values. Which peak variables
are available in a <code>Spectra</code> object can be determined with
the <code><a href="../reference/spectraData.html">peaksVariables()</a></code> function.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">peaksVariables</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "mz"        "intensity"</span></span></code></pre>
<p>These can be passed to the <code><a href="../reference/spectraData.html">peaksData()</a></code> function with
parameter <code>columns</code> to extract the peak variables of
interest. By default <code><a href="../reference/spectraData.html">peaksData()</a></code> extracts m/z and intensity
values.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spectraData.html">peaksData</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span>
<span><span class="va">pks</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##          mz intensity</span></span>
<span><span class="co">## [1,] 109.20     3.407</span></span>
<span><span class="co">## [2,] 124.20    47.494</span></span>
<span><span class="co">## [3,] 124.50     3.094</span></span>
<span><span class="co">## [4,] 170.16   100.000</span></span>
<span><span class="co">## [5,] 170.52    13.240</span></span></code></pre>
<p>Note that we would get the same result by using the <code><a href="https://rdrr.io/r/methods/as.html" class="external-link">as()</a></code>
method to coerce a <code>Spectra</code> object to a <code>list</code> or
<code>SimpleList</code>:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">sps</span>, <span class="st">"SimpleList"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of length 3</span></span></code></pre>
<p>The <code><a href="../reference/spectraData.html">spectraData()</a></code> function returns a
<code>DataFrame</code> with the full data for each spectrum (except m/z
and intensity values), or with selected spectra variables (which can be
specified with the <code>columns</code> parameter). Below we extract the
spectra data for variables <code>"msLevel"</code>, <code>"id"</code> and
<code>"name"</code>.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">spectraData</a></span><span class="op">(</span><span class="va">sps</span>, columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"msLevel"</span>, <span class="st">"id"</span>, <span class="st">"name"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 3 rows and 3 columns</span></span>
<span><span class="co">##     msLevel          id              name</span></span>
<span><span class="co">##   &lt;integer&gt; &lt;character&gt;       &lt;character&gt;</span></span>
<span><span class="co">## 1         2 HMDB0000001 1-Methylhistidine</span></span>
<span><span class="co">## 2         2 HMDB0000001 1-Methylhistidine</span></span>
<span><span class="co">## 3         2 HMDB0001847          Caffeine</span></span></code></pre>
<p><code>Spectra</code> are one-dimensional objects storing spectra,
even from different files or samples, in a single list. Specific
variables have thus to be used to define the originating file from which
they were extracted or the sample in which they were measured. The
<em>data origin</em> of each spectrum can be extracted with the
<code><a href="../reference/spectraData.html">dataOrigin()</a></code> function. For <code>sps</code>, the
<code>Spectra</code> created from a <code>DataFrame</code>, this will be
<code>NA</code> because we did not specify the data origin:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">dataOrigin</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] NA NA NA</span></span></code></pre>
<p><code>dataOrigin</code> for <code>sps_sciex</code>, the
<code>Spectra</code> which was initialized with data from mzML files, in
contrast, returns the originating file names:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/path.html" class="external-link">basename</a></span><span class="op">(</span><span class="fu"><a href="../reference/spectraData.html">dataOrigin</a></span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"</span></span>
<span><span class="co">## [3] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"</span></span>
<span><span class="co">## [5] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"</span></span></code></pre>
<p>The current data storage location of a spectrum can be retrieved with
the <code>dataStorage</code> variable, which will return an arbitrary
string for <code>Spectra</code> that use an in-memory backend or the
file where the data is stored for on-disk backends:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">dataStorage</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "&lt;memory&gt;" "&lt;memory&gt;" "&lt;memory&gt;"</span></span></code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/path.html" class="external-link">basename</a></span><span class="op">(</span><span class="fu"><a href="../reference/spectraData.html">dataStorage</a></span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"</span></span>
<span><span class="co">## [3] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"</span></span>
<span><span class="co">## [5] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"</span></span></code></pre>
<p>Certain backends (such as the <code>MsBackendMemory</code> and
<code>MsBackendDataFrame</code>) support also additional peaks
variables. At present, these must already be present when the backend
gets initialized. In future a dedicated function allowing to add peaks
variables will be available. Below we thus first extract the full data
(including peaks variables) from the <code>sps</code> spectra object and
add a column <code>"peak_anno"</code> with <em>peak annotations</em> for
each individual peak. Importantly, for peak variables, a value needs to
be assigned to each individual peak, even it it is <code>NA</code> (the
<code><a href="../reference/spectraData.html">lengths()</a></code> of the new peak variable must match
<code><a href="../reference/spectraData.html">lengths()</a></code> of <code>mz</code> or <code>intensity</code>,
i.e. the number of peaks per spectrum).</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Extract the full data from a spectrum</span></span>
<span><span class="va">spd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spectraData.html">spectraData</a></span><span class="op">(</span><span class="va">sps</span>, columns <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">union</a></span><span class="op">(</span><span class="fu"><a href="../reference/spectraData.html">spectraVariables</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>,</span>
<span>                                        <span class="fu"><a href="../reference/spectraData.html">peaksVariables</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## Add a new column with a *annotation* for each peak</span></span>
<span><span class="va">spd</span><span class="op">$</span><span class="va">peak_anno</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="cn">NA_character_</span>, <span class="st">"b"</span>, <span class="st">"c"</span>, <span class="st">"d"</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>, <span class="st">"d"</span>, <span class="st">"e"</span>, <span class="st">"f"</span>, <span class="st">"g"</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>, <span class="st">"d"</span>, <span class="st">"e"</span>, <span class="st">"f"</span>, <span class="st">"g"</span>, <span class="st">"h"</span>, <span class="st">"i"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## lengths have to match:</span></span>
<span><span class="fu"><a href="../reference/spectraData.html">lengths</a></span><span class="op">(</span><span class="va">spd</span><span class="op">$</span><span class="va">peak_anno</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 5 7 9</span></span></code></pre>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">lengths</a></span><span class="op">(</span><span class="va">spd</span><span class="op">$</span><span class="va">mz</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 5 7 9</span></span></code></pre>
<p>The parameter <code><a href="../reference/spectraData.html">peaksVariables()</a></code> (currently only available
for the <code><a href="../reference/MsBackend.html">backendInitialize()</a></code> method of
<code>MsBackendMemory</code> and <code>MsBackendDataFrame</code>) allows
to define which of the columns from an input data contain peaks
variables (in our case <code>"mz"</code>, <code>"intensity"</code> and
the additional <code>"peak_anno"</code> column).</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">spd</span>, backend <span class="op">=</span> <span class="fu"><a href="../reference/MsBackend.html">MsBackendMemory</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                peaksVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mz"</span>, <span class="st">"intensity"</span>, <span class="st">"peak_anno"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spectraData.html">peaksVariables</a></span><span class="op">(</span><span class="va">sps2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "mz"        "intensity" "peak_anno"</span></span></code></pre>
<p>Full peak data can be extracted with the <code><a href="../reference/spectraData.html">peaksData()</a></code>
function that has a second parameter <code>columns</code> allowing to
define which peak variables to return. Below we extract the peak data
for the second spectrum.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">peaksData</a></span><span class="op">(</span><span class="va">sps2</span>, columns <span class="op">=</span> <span class="fu"><a href="../reference/spectraData.html">peaksVariables</a></span><span class="op">(</span><span class="va">sps2</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">2L</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##       mz intensity peak_anno</span></span>
<span><span class="co">## 1  83.10     6.685         a</span></span>
<span><span class="co">## 2  96.12     4.381         b</span></span>
<span><span class="co">## 3  97.14     3.022         c</span></span>
<span><span class="co">## 4 109.14    16.708         d</span></span>
<span><span class="co">## 5 124.08   100.000         e</span></span>
<span><span class="co">## 6 125.10     4.565         f</span></span>
<span><span class="co">## 7 170.16    40.643         g</span></span></code></pre>
<p>We can also use the <code><a href="../reference/spectraData.html">peaksData()</a></code> function to extract the
values for individual peak variables.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Peak annotations for the first spectrum</span></span>
<span><span class="fu"><a href="../reference/spectraData.html">peaksData</a></span><span class="op">(</span><span class="va">sps2</span>, <span class="st">"peak_anno"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##   peak_anno</span></span>
<span><span class="co">## 1         a</span></span>
<span><span class="co">## 2      &lt;NA&gt;</span></span>
<span><span class="co">## 3         b</span></span>
<span><span class="co">## 4         c</span></span>
<span><span class="co">## 5         d</span></span></code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Peak annotations for the second spectrum</span></span>
<span><span class="fu"><a href="../reference/spectraData.html">peaksData</a></span><span class="op">(</span><span class="va">sps2</span>, <span class="st">"peak_anno"</span><span class="op">)</span><span class="op">[[</span><span class="fl">2L</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##   peak_anno</span></span>
<span><span class="co">## 1         a</span></span>
<span><span class="co">## 2         b</span></span>
<span><span class="co">## 3         c</span></span>
<span><span class="co">## 4         d</span></span>
<span><span class="co">## 5         e</span></span>
<span><span class="co">## 6         f</span></span>
<span><span class="co">## 7         g</span></span></code></pre>
<p>Peak variables can also be extracted using the <code>$</code>
method:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps2</span><span class="op">$</span><span class="va">peak_anno</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] "a" NA  "b" "c" "d"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [1] "a" "b" "c" "d" "e" "f" "g"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## [1] "a" "b" "c" "d" "e" "f" "g" "h" "i"</span></span></code></pre>
<p>Similar to spectra variables it is also possible to replace values
for <strong>existing</strong> peaks variables using the
<code>$&lt;-</code> function.</p>
</div>
<div class="section level3">
<h3 id="filtering-aggregating-and-merging-spectra-data">Filtering, aggregating and merging spectra data<a class="anchor" aria-label="anchor" href="#filtering-aggregating-and-merging-spectra-data"></a>
</h3>
<p>Various functions are available to filter, subset and merge
<code>Spectra</code> objects. These can be generally subdivided into
functions that subset or filter <em>spectra data</em> and operations
that filter <em>mass peak data</em>. A third category of function allows
to aggregate data within a <code>Spectra</code> or to merge and combine
multiple <code>Spectra</code> objects into one. Functions of the various
categories are described in the following subsections. Please refer to
the function’s documentation for more details and information.</p>
<div class="section level4">
<h4 id="filter-spectra-data">Filter spectra data<a class="anchor" aria-label="anchor" href="#filter-spectra-data"></a>
</h4>
<p>These functions comprise subset operations that reduce the total
number of spectra in a <code>Spectra</code> object as well as filter
functions that reduce the content of the <code>Spectra</code>’s spectra
data (i.e. the content of its <code><a href="../reference/spectraData.html">spectraVariables()</a></code>). These
functions thus don’t change or affect the mass peaks data of the
<code>Spectra</code>’s individual spectra.</p>
<ul>
<li>
<code>[</code>: operation to reduce a <code>Spectra</code> object to
selected elements.</li>
<li>
<code><a href="../reference/filterMsLevel.html">dropNaSpectraVariables()</a></code>: drops
<code><a href="../reference/spectraData.html">spectraVariables()</a></code> that contain only missing values. The
function returns a <code>Spectra</code> object with the same number of
elements, but with eventually fewer spectra variables.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterAcquisitionNum()</a></code>: retains spectra with certain
acquisition numbers.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterDataOrigin()</a></code>: subsets to spectra from specific
origins.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterDataStorage()</a></code>: subsets to spectra from certain
data storage files.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterEmptySpectra()</a></code>: removes spectra without mass
peaks.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterIsolationWindow()</a></code>: keeps spectra with the
provided <code>mz</code> in their isolation window (m/z range).</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterMsLevel()</a></code>: filters by MS level.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterPolarity()</a></code>: filters by polarity.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterPrecursorCharge()</a></code>: retains (MSn) spectra with
specified precursor charge(s).</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterPrecursorIsotopes()</a></code>: identifies precursor ions
(from fragment spectra) that could represent isotopes of the same
molecule. For each of these spectra groups only the spectrum of the
monoisotopic precursor ion is returned. MS1 spectra are returned without
filtering.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterPrecursorMaxIntensity()</a></code>: filters spectra keeping,
for groups of spectra with similar precursor m/z, the one spectrum with
the highest precursor intensity. All MS1 spectra are returned without
filtering.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterPrecursorMzRange()</a></code>: retains (MSn) spectra with a
precursor m/z within the provided m/z range.</li>
<li>
<code>filterPrecursorMzValues(()</code>: retains (MSn) spectra with
precursor m/z value matching the provided value(s) considering also a
<code>tolerance</code> and <code>ppm</code>.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterPrecursorScan()</a></code>: retains (parent and children)
scans of an acquisition number.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterRanges()</a></code>: filters a <code>Spectra</code> object
based on (multiple) user defined <em>numeric</em> ranges for one or more
available (numeric) spectra variables.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterRt()</a></code>: filters based on retention time range.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterValues()</a></code>: filters a <code>Spectra</code> object
based on similarities of <em>numeric</em> values of one or more
available spectra variables.</li>
<li>
<code><a href="../reference/filterMsLevel.html">selectSpectraVariables()</a></code>: reduces the (spectra) data
within the object to the selected spectra variables.</li>
</ul>
</div>
<div class="section level4">
<h4 id="filter-or-aggregate-mass-peak-data">Filter or aggregate mass peak data<a class="anchor" aria-label="anchor" href="#filter-or-aggregate-mass-peak-data"></a>
</h4>
<p>These function filter or aggregate the mass peak data
(<code><a href="../reference/spectraData.html">peaksData()</a></code>) of each spectrum in a <code>Spectra</code>
without changing the total number of spectra.</p>
<ul>
<li>
<code><a href="../reference/combinePeaks.html">combinePeaks()</a></code>: groups peaks <strong>within each
spectrum</strong> based on similarity of their m/z values and combines
these into a single peak per peak group.</li>
<li>
<code><a href="../reference/filterMsLevel.html">deisotopeSpectra()</a></code>: deisotopes each individual spectrum
keeping only the monoisotopic peak for peaks groups of potential
isotopologues.</li>
<li>
<code><a href="../reference/filterFourierTransformArtefacts.html">filterFourierTransformArtefacts()</a></code>: removes (Orbitrap)
fast fourier transform artifact peaks from spectra.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterIntensity()</a></code>: filter each spectrum keeping only
peaks with intensities meeting certain criteria.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterMzRange()</a></code>: filters mass peaks keeping (or
removing) those with an m/z within the provided m/z range.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterMzValues()</a></code>: filters mass peaks within each
spectrum keeping (or removing) those with an m/z matching the provided
value(s).</li>
<li>
<code><a href="../reference/filterPeaksRanges.html">filterPeaksRanges()</a></code>: filters mass peaks using any set
of range-based filters on numeric spectra or peaks variables.</li>
<li>
<code><a href="../reference/filterMsLevel.html">filterPrecursorPeaks()</a></code>: removes peaks with either an
m/z value matching the precursor m/z of the respective spectrum (with
parameter <code>mz = "=="</code>) or peaks with an m/z value larger or
equal to the precursor m/z (with parameter
<code>mz = "&gt;="</code>).</li>
<li>
<code><a href="../reference/filterMsLevel.html">reduceSpectra()</a></code>: filters individual spectra keeping
only the largest peak for groups of peaks with similar m/z values.</li>
</ul>
</div>
<div class="section level4">
<h4 id="merging-aggregating-and-splitting">Merging, aggregating and splitting<a class="anchor" aria-label="anchor" href="#merging-aggregating-and-splitting"></a>
</h4>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code>: combine several <code>Spectra</code> into a single
<code>Spectra</code> object.</li>
<li>
<code><a href="../reference/combineSpectra.html">combineSpectra()</a></code>: allows to combine the MS data from
sets of spectra into a single spectrum per set. Thus, instead of
filtering the data, this function aggregates it.</li>
<li>
<code><a href="../reference/combineSpectra.html">joinSpectraData()</a></code>: merge a <code>DataFrame</code> to
the existing spectra data.</li>
<li>
<code><a href="../reference/combineSpectra.html">split()</a></code>: splits the <code>Spectra</code> object based
on a provided grouping factor.</li>
</ul>
</div>
<div class="section level4">
<h4 id="examples-and-use-cases-for-filter-operations">Examples and use cases for filter operations<a class="anchor" aria-label="anchor" href="#examples-and-use-cases-for-filter-operations"></a>
</h4>
<p>In this example, we use the <code><a href="../reference/filterMsLevel.html">filterValues()</a></code> function to
retain spectra with a base peak m/z close to 100 (+/- 30 ppm) and a
retention time around 230 (+/- 5 s).</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filterMsLevel.html">filterValues</a></span><span class="op">(</span><span class="va">sps_sciex</span>, spectraVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basePeakMZ"</span>, <span class="st">"rtime"</span><span class="op">)</span>,</span>
<span>                        values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">123.089</span>, <span class="fl">230</span><span class="op">)</span>, tolerance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span>,</span>
<span>                        ppm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">0</span><span class="op">)</span>, match <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sps_sub</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 72</span></span></code></pre>
<p>Then, we demonstrate the usage of the <code><a href="../reference/filterMsLevel.html">filterRanges()</a></code>
function to filter spectra based on ranges of values for variables such
as base peak m/z, peak count, and retention time.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_ranges</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filterMsLevel.html">filterRanges</a></span><span class="op">(</span><span class="va">sps_sciex</span>,</span>
<span>                           spectraVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basePeakMZ"</span>,<span class="st">"peaksCount"</span>,</span>
<span>                                                <span class="st">"rtime"</span><span class="op">)</span>,</span>
<span>                           ranges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">123.09</span>,<span class="fl">124</span>, <span class="fl">3500</span>, <span class="fl">3520</span>, <span class="fl">259</span>, <span class="fl">260</span><span class="op">)</span>,</span>
<span>                           match <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sps_ranges</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1</span></span></code></pre>
<p>Only one spectrum matches all the ranges. Another option for
<code><a href="../reference/filterMsLevel.html">filterValues()</a></code> and <code><a href="../reference/filterMsLevel.html">filterRanges()</a></code> is to use
the parameter <code>match = "any"</code>, which retains spectra that
match any one of the conditions instead of having to match all of them.
Let’s run the code once again but change the match parameter this
time:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_ranges</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filterMsLevel.html">filterRanges</a></span><span class="op">(</span><span class="va">sps_sciex</span>,</span>
<span>                           spectraVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basePeakMZ"</span>,</span>
<span>                                                <span class="st">"peaksCount"</span>, <span class="st">"rtime"</span><span class="op">)</span>,</span>
<span>                           ranges <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">123.09</span>, <span class="fl">124</span>, <span class="fl">3500</span>, <span class="fl">3520</span>, <span class="fl">259</span>, <span class="fl">260</span><span class="op">)</span>,</span>
<span>                           match <span class="op">=</span> <span class="st">"any"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sps_ranges</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 473</span></span></code></pre>
<p>We can see many more spectra passed the filtering step this time.</p>
<p>In the example below we use specific functions to select all spectra
measured in the second mzML file and subsequently filter them to retain
spectra measured between 175 and 189 seconds in the measurement run.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="../reference/spectraData.html">dataOrigin</a></span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">file_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filterMsLevel.html">filterDataOrigin</a></span><span class="op">(</span><span class="va">sps_sciex</span>, dataOrigin <span class="op">=</span> <span class="va">fls</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">file_2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 931</span></span></code></pre>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filterMsLevel.html">filterRt</a></span><span class="op">(</span><span class="va">file_2</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">175</span>, <span class="fl">189</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sps_sub</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 50</span></span></code></pre>
<p>In addition, <code>Spectra</code> support also subsetting with
<code>[</code>. Below we perform the filtering above with <code>[</code>
-based subsetting.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_sciex</span><span class="op">[</span><span class="va">sps_sciex</span><span class="op">$</span><span class="va">dataOrigin</span> <span class="op">==</span> <span class="va">fls</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&amp;</span></span>
<span>          <span class="va">sps_sciex</span><span class="op">$</span><span class="va">rtime</span> <span class="op">&gt;=</span> <span class="fl">175</span> <span class="op">&amp;</span></span>
<span>          <span class="va">sps_sciex</span><span class="op">$</span><span class="va">rtime</span> <span class="op">&lt;=</span> <span class="fl">189</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 50 spectra in a MsBackendMzR backend:</span></span>
<span><span class="co">##       msLevel     rtime scanIndex</span></span>
<span><span class="co">##     &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1           1   175.212       628</span></span>
<span><span class="co">## 2           1   175.491       629</span></span>
<span><span class="co">## 3           1   175.770       630</span></span>
<span><span class="co">## 4           1   176.049       631</span></span>
<span><span class="co">## 5           1   176.328       632</span></span>
<span><span class="co">## ...       ...       ...       ...</span></span>
<span><span class="co">## 46          1   187.768       673</span></span>
<span><span class="co">## 47          1   188.047       674</span></span>
<span><span class="co">## 48          1   188.326       675</span></span>
<span><span class="co">## 49          1   188.605       676</span></span>
<span><span class="co">## 50          1   188.884       677</span></span>
<span><span class="co">##  ... 34 more variables/columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## file(s):</span></span>
<span><span class="co">## 20171016_POOL_POS_3_105-134.mzML</span></span></code></pre>
<p>The equivalent using filter function is shown below, with the added
benefit that the filtering is recorded in the processing slot.</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_sciex</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/filterMsLevel.html">filterDataOrigin</a></span><span class="op">(</span><span class="va">fls</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/filterMsLevel.html">filterRt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">175</span>, <span class="fl">189</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 50 spectra in a MsBackendMzR backend:</span></span>
<span><span class="co">##       msLevel     rtime scanIndex</span></span>
<span><span class="co">##     &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1           1   175.212       628</span></span>
<span><span class="co">## 2           1   175.491       629</span></span>
<span><span class="co">## 3           1   175.770       630</span></span>
<span><span class="co">## 4           1   176.049       631</span></span>
<span><span class="co">## 5           1   176.328       632</span></span>
<span><span class="co">## ...       ...       ...       ...</span></span>
<span><span class="co">## 46          1   187.768       673</span></span>
<span><span class="co">## 47          1   188.047       674</span></span>
<span><span class="co">## 48          1   188.326       675</span></span>
<span><span class="co">## 49          1   188.605       676</span></span>
<span><span class="co">## 50          1   188.884       677</span></span>
<span><span class="co">##  ... 34 more variables/columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## file(s):</span></span>
<span><span class="co">## 20171016_POOL_POS_3_105-134.mzML</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Filter: select data origin(s) /__w/_temp/Library/msdata/sciex/20171016_POOL_POS_3_105-134.mzML [Thu Aug 28 08:26:11 2025]</span></span>
<span><span class="co">##  Filter: select retention time [175..189] on MS level(s)  [Thu Aug 28 08:26:11 2025]</span></span></code></pre>
<p>Note that the use of the filter functions might be more efficient for
some backends, depending on their implementation, (e.g. database-based
backends could <em>translate</em> the filter function into a SQL
condition to perform the subsetting already within the database).</p>
<p>Multiple <code>Spectra</code> objects can also be combined into a
single <code>Spectra</code> with the <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> or the
<code><a href="../reference/combineSpectra.html">concatenateSpectra()</a></code> function. The resulting
<code>Spectra</code> object will contain an union of the spectra
variables of the individual objects. Below we combine the
<code>Spectra</code> object <code>sps</code> with an additional object
containing another MS2 spectrum for Caffeine.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">caf_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/DataFrame-class.html" class="external-link">DataFrame</a></span><span class="op">(</span>msLevel <span class="op">=</span> <span class="fl">2L</span>, name <span class="op">=</span> <span class="st">"Caffeine"</span>,</span>
<span>                    id <span class="op">=</span> <span class="st">"HMDB0001847"</span>,</span>
<span>                    instrument <span class="op">=</span> <span class="st">"Agilent 1200 RRLC; Agilent 6520 QTOF"</span>,</span>
<span>                    splash <span class="op">=</span> <span class="st">"splash10-0002-0900000000-413259091ba7edc46b87"</span>,</span>
<span>                    centroided <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">caf_df</span><span class="op">$</span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">110.0710</span>, <span class="fl">138.0655</span>, <span class="fl">138.1057</span>, <span class="fl">138.1742</span>, <span class="fl">195.9864</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">caf_df</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.837</span>, <span class="fl">32.341</span>, <span class="fl">0.84</span>, <span class="fl">0.534</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">caf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">caf_df</span><span class="op">)</span></span></code></pre></div>
<p>Next we combine the two objects.</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combineSpectra.html">concatenateSpectra</a></span><span class="op">(</span><span class="va">sps</span>, <span class="va">caf</span><span class="op">)</span></span>
<span><span class="va">sps</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 4 spectra in a MsBackendMemory backend:</span></span>
<span><span class="co">##     msLevel     rtime scanIndex</span></span>
<span><span class="co">##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1         2        NA        NA</span></span>
<span><span class="co">## 2         2        NA        NA</span></span>
<span><span class="co">## 3         2        NA        NA</span></span>
<span><span class="co">## 4         2        NA        NA</span></span>
<span><span class="co">##  ... 20 more variables/columns.</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Merge 2 Spectra into one [Thu Aug 28 08:26:11 2025]</span></span></code></pre>
<p>The resulting object contains now the data for all 4 MS2 spectra and
an union of all spectra variables from both objects.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">spectraVariables</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                 "rtime"                  </span></span>
<span><span class="co">##  [3] "acquisitionNum"          "scanIndex"              </span></span>
<span><span class="co">##  [5] "dataStorage"             "dataOrigin"             </span></span>
<span><span class="co">##  [7] "centroided"              "smoothed"               </span></span>
<span><span class="co">##  [9] "polarity"                "precScanNum"            </span></span>
<span><span class="co">## [11] "precursorMz"             "precursorIntensity"     </span></span>
<span><span class="co">## [13] "precursorCharge"         "collisionEnergy"        </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"</span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"  "id"                     </span></span>
<span><span class="co">## [19] "name"                    "splash"                 </span></span>
<span><span class="co">## [21] "instrument"</span></span></code></pre>
<p>The second object had an additional spectra variable
<em>instrument</em> that was not present in <code>sps</code> and all the
spectra in this object will thus get a value of <code>NA</code> for this
variable.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps</span><span class="op">$</span><span class="va">instrument</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] NA                                    </span></span>
<span><span class="co">## [2] NA                                    </span></span>
<span><span class="co">## [3] NA                                    </span></span>
<span><span class="co">## [4] "Agilent 1200 RRLC; Agilent 6520 QTOF"</span></span></code></pre>
<p>Sometimes not all spectra variables might be required (e.g. also
because many of them are empty). This might be specifically interesting
also for <code>Spectra</code> containing the data from very large
experiments, because it can significantly reduce the object’s size in
memory. In such cases the <code><a href="../reference/filterMsLevel.html">selectSpectraVariables()</a></code> function
can be used to retain only specified spectra variables.</p>
</div>
</div>
<div class="section level3">
<h3 id="data-manipulations">Data manipulations<a class="anchor" aria-label="anchor" href="#data-manipulations"></a>
</h3>
<p>Some analyses require manipulation of the mass peak data (i.e. the
m/z and/or intensity values). One example would be to remove all peaks
from a spectrum that have an intensity lower than a certain threshold.
Below we perform such an operation with the
<code><a href="../reference/addProcessing.html">replaceIntensitiesBelow()</a></code> function to replace peak
intensities below 10 in each spectrum in <code>sps</code> with a value
of 0.</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">replaceIntensitiesBelow</a></span><span class="op">(</span><span class="va">sps</span>, threshold <span class="op">=</span> <span class="fl">10</span>, value <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>As a result intensities below 10 were set to 0 for all peaks.</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">intensity</a></span><span class="op">(</span><span class="va">sps_rep</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 4</span></span>
<span><span class="co">## [[1]] 0 47.494 0 100 13.24</span></span>
<span><span class="co">## [[2]] 0 0 0 16.708 100 0 40.643</span></span>
<span><span class="co">## [[3]] 0 0 0 0 0 0 0 100 40.994</span></span>
<span><span class="co">## [[4]] 0 32.341 0 0 100</span></span></code></pre>
<p>Zero-intensity peaks (and peaks with missing intensities) can then be
removed with the <code><a href="../reference/filterMsLevel.html">filterIntensity()</a></code> function specifying a
lower required intensity level or optionally also an upper intensity
limit.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filterMsLevel.html">filterIntensity</a></span><span class="op">(</span><span class="va">sps_rep</span>, intensity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="cn">Inf</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">intensity</a></span><span class="op">(</span><span class="va">sps_rep</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 4</span></span>
<span><span class="co">## [[1]] 47.494 100 13.24</span></span>
<span><span class="co">## [[2]] 16.708 100 40.643</span></span>
<span><span class="co">## [[3]] 100 40.994</span></span>
<span><span class="co">## [[4]] 32.341 100</span></span></code></pre>
<p>The <code><a href="../reference/filterMsLevel.html">filterIntensity()</a></code> supports also a user-provided
function to be passed with parameter <code>intensity</code> which would
allow e.g. to remove peaks smaller than the median peak intensity of a
spectrum. See examples in the <code><a href="../reference/filterMsLevel.html">?filterIntensity</a></code> help page
for details.</p>
<p>Note that any data manipulations on <code>Spectra</code> objects are
not immediately applied to the peak data. They are added to a so called
<em>processing queue</em> which is applied each time peak data is
accessed (with the <code><a href="../reference/spectraData.html">peaksData()</a></code>, <code><a href="../reference/spectraData.html">mz()</a></code> or
<code><a href="../reference/spectraData.html">intensity()</a></code> functions). Thanks to this processing queue
data manipulation operations are also possible for <em>read-only</em>
backends (e.g. mzML-file based backends or database-based backends). The
information about the number of such processing steps can be seen below
(next to <em>Lazy evaluation queue</em>).</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_rep</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 4 spectra in a MsBackendMemory backend:</span></span>
<span><span class="co">##     msLevel     rtime scanIndex</span></span>
<span><span class="co">##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1         2        NA        NA</span></span>
<span><span class="co">## 2         2        NA        NA</span></span>
<span><span class="co">## 3         2        NA        NA</span></span>
<span><span class="co">## 4         2        NA        NA</span></span>
<span><span class="co">##  ... 20 more variables/columns.</span></span>
<span><span class="co">## Lazy evaluation queue: 2 processing step(s)</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Merge 2 Spectra into one [Thu Aug 28 08:26:11 2025]</span></span>
<span><span class="co">##  Signal &lt;= 10 in MS level(s) 2 set to 0 [Thu Aug 28 08:26:11 2025]</span></span>
<span><span class="co">##  Remove peaks with intensities outside [0.1, Inf] in spectra of MS level(s) 2. [Thu Aug 28 08:26:11 2025]</span></span></code></pre>
<p>It is possible to add also custom functions to the processing queue
of a <code>Spectra</code> object. Such a function must take a peaks
matrix as its first argument, have <code>...</code> in the function
definition and must return a peaks matrix (a peaks matrix is a numeric
two-column matrix with the first column containing the peaks’ m/z values
and the second the corresponding intensities). Below we define a
function that divides the intensities of each peak by a value which can
be passed with argument <code>y</code>.</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Define a function that takes a matrix as input, divides the second</span></span>
<span><span class="co">## column by parameter y and returns it. Note that ... is required in</span></span>
<span><span class="co">## the function's definition.</span></span>
<span><span class="va">divide_intensities</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="va">y</span></span>
<span>    <span class="va">x</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Add the function to the procesing queue</span></span>
<span><span class="va">sps_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">addProcessing</a></span><span class="op">(</span><span class="va">sps_rep</span>, <span class="va">divide_intensities</span>, y <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">sps_2</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 4 spectra in a MsBackendMemory backend:</span></span>
<span><span class="co">##     msLevel     rtime scanIndex</span></span>
<span><span class="co">##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1         2        NA        NA</span></span>
<span><span class="co">## 2         2        NA        NA</span></span>
<span><span class="co">## 3         2        NA        NA</span></span>
<span><span class="co">## 4         2        NA        NA</span></span>
<span><span class="co">##  ... 20 more variables/columns.</span></span>
<span><span class="co">## Lazy evaluation queue: 3 processing step(s)</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Merge 2 Spectra into one [Thu Aug 28 08:26:11 2025]</span></span>
<span><span class="co">##  Signal &lt;= 10 in MS level(s) 2 set to 0 [Thu Aug 28 08:26:11 2025]</span></span>
<span><span class="co">##  Remove peaks with intensities outside [0.1, Inf] in spectra of MS level(s) 2. [Thu Aug 28 08:26:11 2025]</span></span></code></pre>
<p>Object <code>sps_2</code> has now 3 processing steps in its lazy
evaluation queue. Calling <code><a href="../reference/spectraData.html">intensity()</a></code> on this object will
now return intensities that are half of the intensities of the original
objects <code>sps</code>.</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">intensity</a></span><span class="op">(</span><span class="va">sps_2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 4</span></span>
<span><span class="co">## [[1]] 23.747 50 6.62</span></span>
<span><span class="co">## [[2]] 8.354 50 20.3215</span></span>
<span><span class="co">## [[3]] 50 20.497</span></span>
<span><span class="co">## [[4]] 16.1705 50</span></span></code></pre>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">intensity</a></span><span class="op">(</span><span class="va">sps_rep</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 4</span></span>
<span><span class="co">## [[1]] 47.494 100 13.24</span></span>
<span><span class="co">## [[2]] 16.708 100 40.643</span></span>
<span><span class="co">## [[3]] 100 40.994</span></span>
<span><span class="co">## [[4]] 32.341 100</span></span></code></pre>
<p>Alternatively we could define a function that returns the maximum
peak from each spectrum (note: we use the <code><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname()</a></code> function
to remove any names from the results):</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">max_peak</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sps_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">addProcessing</a></span><span class="op">(</span><span class="va">sps_rep</span>, <span class="va">max_peak</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spectraData.html">lengths</a></span><span class="op">(</span><span class="va">sps_2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1 1 1 1</span></span></code></pre>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">intensity</a></span><span class="op">(</span><span class="va">sps_2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 4</span></span>
<span><span class="co">## [[1]] 100</span></span>
<span><span class="co">## [[2]] 100</span></span>
<span><span class="co">## [[3]] 100</span></span>
<span><span class="co">## [[4]] 100</span></span></code></pre>
<p>Each spectrum in <code>sps_2</code> thus contains only a single peak.
The parameter <code>spectraVariables</code> of the
<code><a href="../reference/addProcessing.html">addProcessing()</a></code> function allows in addition to define
spectra variables that should be passed (in addition to the peaks
matrix) to the user-provided function. This would enable for example to
calculate <em>neutral loss</em> spectra from a <code>Spectra</code> by
subtracting the precursor m/z from each m/z of a spectrum (note that
there would also be a dedicated <code><a href="../reference/neutralLoss.html">neutralLoss()</a></code> function to
perform this operation more efficiently). Our tool example does not have
precursor m/z values defined, thus we first set them to arbitrary
values. Then we define a function <code>neutral_loss</code> that
calculates the difference between the precursor m/z and the fragment
peak’s m/z. In addition we need to ensure the peaks in the resulting
spectra are ordered by (the delta) m/z values. Note that, in order to be
able to access the precursor m/z of the spectrum within our function, we
have to add a parameter to the function that has the same name as the
spectrum variable we want to access (in our case
<code>precursorMz</code>).</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_rep</span><span class="op">$</span><span class="va">precursorMz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">170.5</span>, <span class="fl">170.5</span>, <span class="fl">195.1</span>, <span class="fl">195.1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">neutral_loss</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">precursorMz</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span><span class="op">[</span>, <span class="st">"mz"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">precursorMz</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span>, <span class="st">"mz"</span><span class="op">]</span></span>
<span>    <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="st">"mz"</span><span class="op">]</span><span class="op">)</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We have then to call <code><a href="../reference/addProcessing.html">addProcessing()</a></code> with
<code>spectraVariables = "precursorMz"</code> to specify that this
spectra variable is passed along to our function.</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">addProcessing</a></span><span class="op">(</span><span class="va">sps_rep</span>, <span class="va">neutral_loss</span>,</span>
<span>                       spectraVariables <span class="op">=</span> <span class="st">"precursorMz"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spectraData.html">mz</a></span><span class="op">(</span><span class="va">sps_rep</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 4</span></span>
<span><span class="co">## [[1]] 124.2 170.16 170.52</span></span>
<span><span class="co">## [[2]] 109.14 124.08 170.16</span></span>
<span><span class="co">## [[3]] 138.0662 195.0876</span></span>
<span><span class="co">## [[4]] 138.0655 195.9864</span></span></code></pre>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">mz</a></span><span class="op">(</span><span class="va">sps_3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 4</span></span>
<span><span class="co">## [[1]] -0.0200000000000102 0.340000000000003 46.3</span></span>
<span><span class="co">## [[2]] 0.340000000000003 46.42 61.36</span></span>
<span><span class="co">## [[3]] 0.0123999999999853 57.0338</span></span>
<span><span class="co">## [[4]] -0.886400000000009 57.0345</span></span></code></pre>
<p>As we can see, the precursor m/z was subtracted from each m/z of the
respective spectrum. A better version of the function, that only
calculates neutral loss spectra for MS level 2 spectra would be the
<code>neutral_loss</code> function below. Since we are accessing also
the spectrum’s MS level we have to call <code><a href="../reference/addProcessing.html">addProcessing()</a></code>
adding also the spectra variable <code>msLevel</code> to the
<code>spectraVariables</code> parameter. Note however that the
<code>msLevel</code> spectra variable <strong>is by default
renamed</strong> to <code>spectrumMsLevel</code> prior passing it to the
function. We have thus to use a parameter called
<code>spectrumMsLevel</code> in the <code>neutral_loss</code> function
instead of <code>msLevel</code>.</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">neutral_loss</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">spectrumMsLevel</span>, <span class="va">precursorMz</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">spectrumMsLevel</span> <span class="op">==</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">x</span><span class="op">[</span>, <span class="st">"mz"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">precursorMz</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span>, <span class="st">"mz"</span><span class="op">]</span></span>
<span>        <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="st">"mz"</span><span class="op">]</span><span class="op">)</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">x</span></span>
<span><span class="op">}</span></span>
<span><span class="va">sps_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">addProcessing</a></span><span class="op">(</span><span class="va">sps_rep</span>, <span class="va">neutral_loss</span>,</span>
<span>                       spectraVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"msLevel"</span>, <span class="st">"precursorMz"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spectraData.html">mz</a></span><span class="op">(</span><span class="va">sps_3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 4</span></span>
<span><span class="co">## [[1]] -0.0200000000000102 0.340000000000003 46.3</span></span>
<span><span class="co">## [[2]] 0.340000000000003 46.42 61.36</span></span>
<span><span class="co">## [[3]] 0.0123999999999853 57.0338</span></span>
<span><span class="co">## [[4]] -0.886400000000009 57.0345</span></span></code></pre>
<p>Using the same concept it would also be possible to provide any
spectrum-specific user-defined value to the processing function. This
variable could simply be added first as a new spectra variable to the
<code>Spectra</code> object and then this variable could be passed along
to the function in the same way we passed the precursor m/z to our
function above.</p>
<p>Another example for spectra processing potentially helpful for
spectral matching against reference fragment spectra libraries would be
a function that removes fragment peaks with an m/z matching the
precursor m/z of a spectrum. Below we define such a function that takes
the peaks matrix and the precursor m/z as input and evaluates with the
<code><a href="https://rdrr.io/pkg/MsCoreUtils/man/matching.html" class="external-link">closest()</a></code> function from the <em><a href="https://bioconductor.org/packages/3.22/MsCoreUtils" class="external-link">MsCoreUtils</a></em>
whether the spectrum contains peaks with an m/z value matching the one
of the precursor (given <code>tolerance</code> and <code>ppm</code>).
The returned peaks matrix contains all peaks except those matching the
precursor m/z.</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsCoreUtils" class="external-link">MsCoreUtils</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'MsCoreUtils'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:Spectra':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     bin, entropy, smooth</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     smooth</span></span></code></pre>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">remove_precursor</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">precursorMz</span>, <span class="va">tolerance</span> <span class="op">=</span> <span class="fl">0.1</span>, <span class="va">ppm</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">precursorMz</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/MsCoreUtils/man/matching.html" class="external-link">closest</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="st">"mz"</span><span class="op">]</span>, <span class="va">precursorMz</span>, tolerance <span class="op">=</span> <span class="va">tolerance</span>,</span>
<span>                             ppm <span class="op">=</span> <span class="va">ppm</span>, .check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">x</span><span class="op">[</span><span class="va">keep</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="va">x</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can now again add this processing step to our <code>Spectra</code>
object. As a result, peaks matching the precursor m/z (with
<code>tolerance = 0.1</code> and <code>ppm = 0</code>) will be
removed.</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">addProcessing</a></span><span class="op">(</span><span class="va">sps_rep</span>, <span class="va">remove_precursor</span>,</span>
<span>                       spectraVariables <span class="op">=</span> <span class="st">"precursorMz"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/spectraData.html">peaksData</a></span><span class="op">(</span><span class="va">sps_4</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">##          mz intensity</span></span>
<span><span class="co">## [1,] 124.20    47.494</span></span>
<span><span class="co">## [2,] 170.16   100.000</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">##          mz intensity</span></span>
<span><span class="co">## [1,] 109.14    16.708</span></span>
<span><span class="co">## [2,] 124.08   100.000</span></span>
<span><span class="co">## [3,] 170.16    40.643</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">##            mz intensity</span></span>
<span><span class="co">## [1,] 138.0662       100</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[4]]</span></span>
<span><span class="co">##            mz intensity</span></span>
<span><span class="co">## [1,] 138.0655    32.341</span></span>
<span><span class="co">## [2,] 195.9864   100.000</span></span></code></pre>
<p>As a reference, the original peak matrices are shown below.</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">peaksData</a></span><span class="op">(</span><span class="va">sps_rep</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">##          mz intensity</span></span>
<span><span class="co">## [1,] 124.20    47.494</span></span>
<span><span class="co">## [2,] 170.16   100.000</span></span>
<span><span class="co">## [3,] 170.52    13.240</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">##          mz intensity</span></span>
<span><span class="co">## [1,] 109.14    16.708</span></span>
<span><span class="co">## [2,] 124.08   100.000</span></span>
<span><span class="co">## [3,] 170.16    40.643</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">##            mz intensity</span></span>
<span><span class="co">## [1,] 138.0662   100.000</span></span>
<span><span class="co">## [2,] 195.0876    40.994</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[4]]</span></span>
<span><span class="co">##            mz intensity</span></span>
<span><span class="co">## [1,] 138.0655    32.341</span></span>
<span><span class="co">## [2,] 195.9864   100.000</span></span></code></pre>
<p>Note that we can also perform a more relaxed matching of m/z values
by passing a different value for <code>tolerance</code> to the
function:</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">addProcessing</a></span><span class="op">(</span><span class="va">sps_rep</span>, <span class="va">remove_precursor</span>, tolerance <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>                       spectraVariables <span class="op">=</span> <span class="st">"precursorMz"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spectraData.html">peaksData</a></span><span class="op">(</span><span class="va">sps_4</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">##         mz intensity</span></span>
<span><span class="co">## [1,] 124.2    47.494</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">##          mz intensity</span></span>
<span><span class="co">## [1,] 109.14    16.708</span></span>
<span><span class="co">## [2,] 124.08   100.000</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">##            mz intensity</span></span>
<span><span class="co">## [1,] 138.0662       100</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[4]]</span></span>
<span><span class="co">##            mz intensity</span></span>
<span><span class="co">## [1,] 138.0655    32.341</span></span>
<span><span class="co">## [2,] 195.9864   100.000</span></span></code></pre>
<p>Since all data manipulations above did not change the original
intensity or m/z values, it is possible to <em>restore</em> the original
data. This can be done with the <code><a href="../reference/addProcessing.html">reset()</a></code> function which will
empty the lazy evaluation queue and call the <code><a href="../reference/addProcessing.html">reset()</a></code> method
on the storage backend. Below we call <code><a href="../reference/addProcessing.html">reset()</a></code> on the
<code>sps_2</code> object and hence restore the data to its original
state.</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_2_rest</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">reset</a></span><span class="op">(</span><span class="va">sps_2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/spectraData.html">intensity</a></span><span class="op">(</span><span class="va">sps_2_rest</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 4</span></span>
<span><span class="co">## [[1]] 3.407 47.494 3.094 100 13.24</span></span>
<span><span class="co">## [[2]] 6.685 4.381 3.022 16.708 100 4.565 40.643</span></span>
<span><span class="co">## [[3]] 0.459 2.585 2.446 0.508 8.968 0.524 0.974 100 40.994</span></span>
<span><span class="co">## [[4]] 3.837 32.341 0.84 0.534 100</span></span></code></pre>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">intensity</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 4</span></span>
<span><span class="co">## [[1]] 3.407 47.494 3.094 100 13.24</span></span>
<span><span class="co">## [[2]] 6.685 4.381 3.022 16.708 100 4.565 40.643</span></span>
<span><span class="co">## [[3]] 0.459 2.585 2.446 0.508 8.968 0.524 0.974 100 40.994</span></span>
<span><span class="co">## [[4]] 3.837 32.341 0.84 0.534 100</span></span></code></pre>
<p>Finally, for <code>Spectra</code> that use a <em>writeable</em>
backend, such as the <code>MsBackendMemory</code>,
<code>MsBackendDataFrame</code> or <code>MsBackendHdf5Peaks</code>, it
is possible to apply the processing queue to the peak data and write
that back to the data storage with the <code><a href="../reference/addProcessing.html">applyProcessing()</a></code>
function. Below we use this to make all data manipulations on peak data
of the <code>sps_rep</code> object persistent.</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sps_rep</span><span class="op">@</span><span class="va">processingQueue</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2</span></span></code></pre>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">applyProcessing</a></span><span class="op">(</span><span class="va">sps_rep</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sps_rep</span><span class="op">@</span><span class="va">processingQueue</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0</span></span></code></pre>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_rep</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 4 spectra in a MsBackendMemory backend:</span></span>
<span><span class="co">##     msLevel     rtime scanIndex</span></span>
<span><span class="co">##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1         2        NA        NA</span></span>
<span><span class="co">## 2         2        NA        NA</span></span>
<span><span class="co">## 3         2        NA        NA</span></span>
<span><span class="co">## 4         2        NA        NA</span></span>
<span><span class="co">##  ... 20 more variables/columns.</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Merge 2 Spectra into one [Thu Aug 28 08:26:11 2025]</span></span>
<span><span class="co">##  Signal &lt;= 10 in MS level(s) 2 set to 0 [Thu Aug 28 08:26:11 2025]</span></span>
<span><span class="co">##  Remove peaks with intensities outside [0.1, Inf] in spectra of MS level(s) 2. [Thu Aug 28 08:26:11 2025]</span></span>
<span><span class="co">##  ...1 more processings. Use 'processingLog' to list all.</span></span></code></pre>
<p>Before <code><a href="../reference/addProcessing.html">applyProcessing()</a></code> the lazy evaluation queue
contained 2 processing steps, which were then applied to the peak data
and <em>written</em> to the data storage. Note that calling
<code><a href="../reference/addProcessing.html">reset()</a></code> <strong>after</strong>
<code><a href="../reference/addProcessing.html">applyProcessing()</a></code> can no longer <em>restore</em> the
data.</p>
</div>
<div class="section level3">
<h3 id="visualizing-spectra">Visualizing <code>Spectra</code><a class="anchor" aria-label="anchor" href="#visualizing-spectra"></a>
</h3>
<p>The <code>Spectra</code> package provides the following functions to
visualize spectra data: - <code><a href="../reference/spectra-plotting.html">plotSpectra()</a></code>: plot each spectrum
in <code>Spectra</code> in its own panel. -
<code><a href="../reference/spectra-plotting.html">plotSpectraOverlay()</a></code>: plot multiple spectra into the
<strong>same</strong> plot.</p>
<p>Below we use <code><a href="../reference/spectra-plotting.html">plotSpectra()</a></code> to plot the 4 spectra from
the <code>sps</code> object using their names (as provided in spectra
variable <code>"name"</code>) as plot titles.</p>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span>, main <span class="op">=</span> <span class="va">sps</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra_files/figure-html/plotspectra-1.png" width="768"></p>
<p>It is also possible to label individual peaks in each plot. Below we
use the m/z value of each peak as its label. In the example we define a
function that accesses information from each spectrum (<code>z</code>)
and returns a <code>character</code> for each peak with the text that
should be used as label. Parameters <code>labelSrt</code>,
<code>labelPos</code> and <code>labelOffset</code> define the rotation
of the label text and its position relative to the x and y coordinates
of the peak.</p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span>, main <span class="op">=</span> <span class="va">sps</span><span class="op">$</span><span class="va">name</span>,</span>
<span>            labels <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="../reference/spectraData.html">mz</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span>, <span class="va">format</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>            labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>, labelPos <span class="op">=</span> <span class="fl">2</span>, labelOffset <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra_files/figure-html/plotspectra-label-1.png" width="768"></p>
<p>These plots are rather busy and for some peaks the m/z values are
overplotted. Below we define a <em>label function</em> that will only
indicate the m/z of peaks with an intensity higher than 30.</p>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mzLabel</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="fu"><a href="../reference/spectraData.html">mz</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">lbls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="../reference/spectraData.html">mz</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span>            <span class="va">lbls</span><span class="op">[</span><span class="fu"><a href="../reference/spectraData.html">intensity</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;=</span> <span class="fl">30</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">""</span></span>
<span>            <span class="va">lbls</span></span>
<span>     <span class="op">}</span><span class="op">)</span></span>
<span> <span class="op">}</span></span>
<span><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span>, main <span class="op">=</span> <span class="va">sps</span><span class="op">$</span><span class="va">name</span>, labels <span class="op">=</span> <span class="va">mzLabel</span>,</span>
<span>            labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>, labelPos <span class="op">=</span> <span class="fl">2</span>, labelOffset <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra_files/figure-html/plotspectra-label-int-1.png" width="768"></p>
<p>Sometimes it might be of interest to plot multiple spectra into the
<strong>same</strong> plot (e.g. to directly compare peaks from multiple
spectra). This can be done with <code><a href="../reference/spectra-plotting.html">plotSpectraOverlay()</a></code> which
we use below to create an <em>overlay-plot</em> of our 4 example
spectra, using a different color for each spectrum.</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#E41A1C80"</span>, <span class="st">"#377EB880"</span>, <span class="st">"#4DAF4A80"</span>, <span class="st">"#984EA380"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectraOverlay</a></span><span class="op">(</span><span class="va">sps</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="va">cols</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, col <span class="op">=</span> <span class="va">cols</span>, legend <span class="op">=</span> <span class="va">sps</span><span class="op">$</span><span class="va">name</span>, pch <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra_files/figure-html/plotspectraoverlay-1.png" width="576"></p>
<p>Lastly, <code><a href="../reference/spectra-plotting.html">plotSpectraMirror()</a></code> allows to plot two spectra
against each other as a <em>mirror plot</em> which is ideal to visualize
spectra comparison results. Below we plot a spectrum of
1-Methylhistidine against one of Caffeine.</p>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectraMirror</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sps</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra_files/figure-html/plotspectramirror-1.png" width="576"></p>
<p>The upper panel shows the spectrum from 1-Methylhistidine, the lower
the one of Caffeine. None of the peaks of the two spectra match. Below
we plot the two spectra of 1-Methylhistidine and the two of Caffeine
against each other matching peaks with a <code>ppm</code> of 50.</p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectraMirror</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sps</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"1-Methylhistidine"</span>, ppm <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectraMirror</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">sps</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Caffeine"</span>, ppm <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra_files/figure-html/plotspectramirror-ppm-1.png" width="1152"></p>
<p>See also <code><a href="../reference/spectra-plotting.html">?plotSpectra</a></code> for more plotting options and
examples.</p>
</div>
<div class="section level3">
<h3 id="aggregating-spectra-data">Aggregating spectra data<a class="anchor" aria-label="anchor" href="#aggregating-spectra-data"></a>
</h3>
<p>The <code>Spectra</code> package provides the
<code><a href="../reference/combineSpectra.html">combineSpectra()</a></code> function that allows to <em>aggregate</em>
multiple spectra into a single one. The main parameters of this function
are <code>f</code>, which defines the sets of spectra that should be
combined, and <code>FUN</code>, which allows to define the function that
performs the actual aggregation. The default aggregation function is
<code><a href="../reference/combinePeaksData.html">combinePeaksData()</a></code> (see <code><a href="../reference/combinePeaksData.html">?combinePeaksData</a></code> for
details) that combines multiple spectra into a single spectrum with all
peaks from all input spectra (with additional paramter
<code>peaks = "union"</code>), or peaks that are present in a certain
proportion of input spectra (with parameter
<code>peaks = "intersect"</code>; parameter <code>minProp</code> allows
to define the minimum required proportion of spectra in which a peak
needs to be present. It is important to mention that, by default, the
function combines all mass peaks from all spectra with a similar m/z
value into a single, representative mass peak aggregating all their
intensities into one. To avoid the resulting intensity to be affected by
potential noise peaks it might be advised to first <em>clean</em> the
individual mass spectra using e.g. the <code><a href="../reference/combinePeaks.html">combinePeaks()</a></code> or
<code><a href="../reference/filterMsLevel.html">reduceSpectra()</a></code> functions that first aggregate mass peaks
<strong>within</strong> each individual spectrum.</p>
<p>In this example we below we use <code><a href="../reference/combineSpectra.html">combineSpectra()</a></code> to
combine the spectra for 1-methylhistidine and caffeine into a single
spectrum for each compound. We use the spectra variable
<code>$name</code>, that contains the names of the compounds, to define
which spectra should be grouped together.</p>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combineSpectra.html">combineSpectra</a></span><span class="op">(</span><span class="va">sps</span>, f <span class="op">=</span> <span class="va">sps</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span></code></pre></div>
<p>As a result, the 4 spectra got aggregated into two.</p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps_agg</span>, main <span class="op">=</span> <span class="va">sps_agg</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra_files/figure-html/unnamed-chunk-16-1.png" width="384"></p>
<p>By default, all peaks present in all spectra are reported. As an
alternative, by specifying <code>peaks = "intersect"</code> and
<code>minProp = 1</code>, we could combine the spectra keeping only
peaks that are present in <strong>both</strong> input spectra.</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combineSpectra.html">combineSpectra</a></span><span class="op">(</span><span class="va">sps</span>, f <span class="op">=</span> <span class="va">sps</span><span class="op">$</span><span class="va">name</span>, peaks <span class="op">=</span> <span class="st">"intersect"</span>, minProp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps_agg</span>, main <span class="op">=</span> <span class="va">sps_agg</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra_files/figure-html/unnamed-chunk-17-1.png" width="384"></p>
<p>This results thus in a single peak for 1-methylhistidine and none for
caffeine - why? The reason for that is that the difference of the peaks’
m/z values is larger than the default tolerance used for the peak
grouping (the defaults for <code><a href="../reference/combinePeaksData.html">combinePeaksData()</a></code> is
<code>tolerance = 0</code> and <code>ppm = 0</code>). We could however
already see in the previous section that the reported peaks’ m/z values
have a larger measurement error (most likely because the fragment
spectra were measured on different instruments with different
precision). Thus, we next increase the <code>tolerance</code> and
<code>ppm</code> parameters to group also peaks with a larger difference
in their m/z values.</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combineSpectra.html">combineSpectra</a></span><span class="op">(</span><span class="va">sps</span>, f <span class="op">=</span> <span class="va">sps</span><span class="op">$</span><span class="va">name</span>, peaks <span class="op">=</span> <span class="st">"intersect"</span>,</span>
<span>                          minProp <span class="op">=</span> <span class="fl">1</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps_agg</span>, main <span class="op">=</span> <span class="va">sps_agg</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra_files/figure-html/unnamed-chunk-18-1.png" width="384"></p>
<p>Whether in a real analysis we would be OK with such a large tolerance
is however questionable. Note: which m/z and intensity is reported for
the aggregated spectra can be defined with the parameters
<code>intensityFun</code> and <code>mzFun</code> of
<code><a href="../reference/combinePeaksData.html">combinePeaksData()</a></code> (see <code><a href="../reference/combinePeaksData.html">?combinePeaksData</a></code> for
more information).</p>
<p>While the <code><a href="../reference/combinePeaksData.html">combinePeaksData()</a></code> function is indeed helpful
to combine peaks from different spectra, the
<code><a href="../reference/combineSpectra.html">combineSpectra()</a></code> function would in addition also allow us
to provide our own, custom, peak aggregation function. As a simple
example, instead of combining the spectra, we would like to select one
of the input spectra as <em>representative</em> spectrum for grouped
input spectra. <code><a href="../reference/combineSpectra.html">combineSpectra()</a></code> supports any function that
takes a list of peak matrices as input and returns a single peak matrix
as output. We thus define below a function that calculates the total
signal (TIC) for each input peak matrix, and returns the one peak matrix
with the largest TIC.</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' function to select and return the peak matrix with the largest tic from</span></span>
<span><span class="co">#' the provided list of peak matrices.</span></span>
<span><span class="va">maxTic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">x</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">tic</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can now use this function with <code><a href="../reference/combineSpectra.html">combineSpectra()</a></code> to
select for each compound the spectrum with the largest TIC.</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combineSpectra.html">combineSpectra</a></span><span class="op">(</span><span class="va">sps</span>, f <span class="op">=</span> <span class="va">sps</span><span class="op">$</span><span class="va">name</span>, FUN <span class="op">=</span> <span class="va">maxTic</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps_agg</span>, main <span class="op">=</span> <span class="va">sps_agg</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra_files/figure-html/unnamed-chunk-20-1.png" width="384"></p>
</div>
<div class="section level3">
<h3 id="comparing-spectra">Comparing spectra<a class="anchor" aria-label="anchor" href="#comparing-spectra"></a>
</h3>
<p>Spectra can be compared with the <code><a href="../reference/compareSpectra.html">compareSpectra()</a></code>
function, that allows to calculate similarities between spectra using a
variety of methods. <code><a href="../reference/compareSpectra.html">compareSpectra()</a></code> implements similarity
scoring as a two-step approach: first the peaks from the pair of spectra
that should be compared are matched (mapped) against each other and then
a similarity score is calculated on these. The <code>MAPFUN</code>
parameter of <code><a href="../reference/compareSpectra.html">compareSpectra()</a></code> defines the function to match
(or map) the peaks between the spectra and parameter <code>FUN</code>
specifies the function to calculate the similarity. By default,
<code><a href="../reference/compareSpectra.html">compareSpectra()</a></code> uses <code>MAPFUN = joinPeaks</code> (see
<code><a href="../reference/joinPeaks.html">?joinPeaks</a></code> for a description and alternative options) and
<code>FUN = ndotproduct</code> (the normalized dot-product spectra
similarity score). Parameters to configure these functions can be passed
to <code><a href="../reference/compareSpectra.html">compareSpectra()</a></code> as additional parameter (such as
e.g. <code>ppm</code> to define the m/z-relative tolerance for peak
matching in <code><a href="../reference/joinPeaks.html">joinPeaks()</a></code>).</p>
<p>Below we calculate pairwise similarities between all spectra in
<code>sps</code> accepting a 50 ppm difference of peaks’ m/z values for
being considered matching.</p>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/compareSpectra.html">compareSpectra</a></span><span class="op">(</span><span class="va">sps</span>, ppm <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           1         2         3         4</span></span>
<span><span class="co">## 1 1.0000000 0.1380817 0.0000000 0.0000000</span></span>
<span><span class="co">## 2 0.1380817 1.0000000 0.0000000 0.0000000</span></span>
<span><span class="co">## 3 0.0000000 0.0000000 1.0000000 0.1817149</span></span>
<span><span class="co">## 4 0.0000000 0.0000000 0.1817149 1.0000000</span></span></code></pre>
<p>The resulting matrix provides the similarity scores from the pairwise
comparison. As expected, the first two and the last two spectra are
similar, albeit only moderately, while the spectra from
1-Methylhistidine don’t share any similarity with those of Caffeine.
Similarities <em>between</em> <code>Spectra</code> objects can be
calculated with calls in the form of <code>compareSpectra(a, b)</code>
with <code>a</code> and <code>b</code> being the two
<code>Spectra</code> objects to compare. As a result a <em>n x m</em>
matrix will be returned with <em>n</em> (rows) being the spectra in
<code>a</code> and <em>m</em> (columns) being the spectra in
<code>b</code>.</p>
<p>By setting parameter <code>matchedPeaksCount = TRUE</code> also the
number of matching peaks between the compared spectra are returned, in
addition to the similarity scores. The result is then a 3-dimensional
<code>array</code> with the similarity scores in the first
<code>matrix</code> in z dimension (<code>[, , 1]</code>) and the number
of matching peaks in the second <code>matrix</code>
(<code>[, , 2]</code>):</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compareSpectra.html">compareSpectra</a></span><span class="op">(</span><span class="va">sps</span>, <span class="va">sps</span>, ppm <span class="op">=</span> <span class="fl">40</span>, matchedPeaksCount <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' The similarity scores:</span></span>
<span><span class="va">sim</span><span class="op">[</span>, , <span class="fl">1L</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##           1         2         3         4</span></span>
<span><span class="co">## 1 1.0000000 0.1380817 0.0000000 0.0000000</span></span>
<span><span class="co">## 2 0.1380817 1.0000000 0.0000000 0.0000000</span></span>
<span><span class="co">## 3 0.0000000 0.0000000 1.0000000 0.1817149</span></span>
<span><span class="co">## 4 0.0000000 0.0000000 0.1817149 1.0000000</span></span></code></pre>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' The number of matching peaks:</span></span>
<span><span class="va">sim</span><span class="op">[</span>, , <span class="fl">2L</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##   1 2 3 4</span></span>
<span><span class="co">## 1 5 1 0 0</span></span>
<span><span class="co">## 2 1 7 0 0</span></span>
<span><span class="co">## 3 0 0 9 2</span></span>
<span><span class="co">## 4 0 0 2 5</span></span></code></pre>
<p>The above similarity was calculated with the default (normalized)
dot-product, but also other similarity scores can be used instead.
Either one of the other metrics provided by the <em><a href="https://bioconductor.org/packages/3.22/MsCoreUtils" class="external-link">MsCoreUtils</a></em>
could be used (see <code><a href="https://rdrr.io/pkg/MsCoreUtils/man/distance.html" class="external-link">?MsCoreUtils::distance</a></code> for a list of
available options) or any other external or user-provided similarity
scoring function. As an example, we use below the spectral entropy
similarity score introduced in <span class="citation">(Y et al.
2021)</span> and provided with the <a href="https://cran.r-project.org/web/packages/msentropy/index.html" class="external-link"><em>msentropy</em></a>
package. Since this <code><a href="https://rdrr.io/pkg/msentropy/man/msentropy_similarity.html" class="external-link">msentropy_similarity()</a></code> function
performs also the mapping of the peaks between the compared spectra
internally (along with some spectra cleaning), we have to disable that
in the <code><a href="../reference/compareSpectra.html">compareSpectra()</a></code> function using
<code>MAPFUN = joinPeaksNone</code>. To configure the similarity scoring
we can pass all additional parameters of the
<code><a href="https://rdrr.io/pkg/msentropy/man/msentropy_similarity.html" class="external-link">msentropy_similarity()</a></code> (see
<code><a href="https://rdrr.io/pkg/msentropy/man/msentropy_similarity.html" class="external-link">?msentropy_similarity</a></code>) to the <code><a href="../reference/compareSpectra.html">compareSpectra()</a></code>
call. We use <code>ms2_tolerance_in_ppm = 50</code> to set the tolerance
for m/z-relative peak matching (equivalent to <code>ppm = 50</code> used
above) and <code>ms2_tolerance_in_da = -1</code> to disable absolute
tolerance matching.</p>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/YuanyueLi/MSEntropy" class="external-link">msentropy</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: Rcpp</span></span></code></pre>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/compareSpectra.html">compareSpectra</a></span><span class="op">(</span><span class="va">sps</span>, MAPFUN <span class="op">=</span> <span class="va">joinPeaksNone</span>, FUN <span class="op">=</span> <span class="va">msentropy_similarity</span>,</span>
<span>               ms2_tolerance_in_ppm <span class="op">=</span> <span class="fl">50</span>, ms2_tolerance_in_da <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           1         2         3         4</span></span>
<span><span class="co">## 1 1.0000000 0.3002225 0.0000000 0.0000000</span></span>
<span><span class="co">## 2 0.3002225 1.0000000 0.0000000 0.0000000</span></span>
<span><span class="co">## 3 0.0000000 0.0000000 1.0000000 0.5144764</span></span>
<span><span class="co">## 4 0.0000000 0.0000000 0.5144764 1.0000000</span></span></code></pre>
<p>Note also that GNPS-like scores can be calculated with
<code>MAPFUN = joinPeaksGnps</code> and
<code>FUN = MsCoreUtils::gnps</code>. For additional information and
examples see also <span class="citation">(Rainer et al. 2022)</span> or
the <a href="https://jorainer.github.io/SpectraTutorials" class="external-link">SpectraTutorials</a>
tutorial.</p>
<p>Another way of comparing spectra would be to <em>bin</em> the spectra
and to cluster them based on similar intensity values. Spectra binning
ensures that the binned m/z values are comparable across all spectra.
Below we bin our spectra using a bin size of 0.1 (i.e. all peaks with an
m/z smaller than 0.1 are aggregated into one binned peak. Below, we
explicitly set <code>zero.rm = FALSE</code> to retain all bins generated
by the function, including those with an intensity of zero.</p>
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_bin</span> <span class="op">&lt;-</span> <span class="fu">Spectra</span><span class="fu">::</span><span class="fu"><a href="../reference/addProcessing.html">bin</a></span><span class="op">(</span><span class="va">sps</span>, binSize <span class="op">=</span> <span class="fl">0.1</span>, zero.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>All spectra will now have the same number of m/z values.</p>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">lengths</a></span><span class="op">(</span><span class="va">sps_bin</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1400 1400 1400 1400</span></span></code></pre>
<p>Most of the intensity values for these will however be 0 (because in
the original spectra no peak for the respective m/z bin was
present).</p>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spectraData.html">intensity</a></span><span class="op">(</span><span class="va">sps_bin</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 4</span></span>
<span><span class="co">## [[1]] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ... 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span></span>
<span><span class="co">## [[2]] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ... 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span></span>
<span><span class="co">## [[3]] 0.459 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ... 0 0 0 0 0 40.994 0 0 0 0 0 0 0 0 0</span></span>
<span><span class="co">## [[4]] 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ... 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 100</span></span></code></pre>
<p>We’re next creating an intensity matrix for our <code>Spectra</code>
object, each row being one spectrum and columns representing the binned
m/z values.</p>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">intmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="../reference/spectraData.html">intensity</a></span><span class="op">(</span><span class="va">sps_bin</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can now identify those columns (m/z bins) with only 0s across all
spectra and remove these.</p>
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zeros</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">intmat</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span></span>
<span><span class="va">intmat</span> <span class="op">&lt;-</span> <span class="va">intmat</span><span class="op">[</span>, <span class="op">!</span><span class="va">zeros</span><span class="op">]</span></span>
<span><span class="va">intmat</span></span></code></pre></div>
<pre><code><span><span class="co">##       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]   [,8]  [,9] [,10] [,11] [,12]</span></span>
<span><span class="co">## [1,] 0.000 0.000 0.000 0.000 0.000 0.000 0.000  0.000 3.407 0.000 0.000 0.000</span></span>
<span><span class="co">## [2,] 0.000 0.000 0.000 6.685 4.381 3.022 0.000 16.708 0.000 0.000 0.000 0.000</span></span>
<span><span class="co">## [3,] 0.459 2.585 2.446 0.000 0.000 0.000 0.508  0.000 0.000 8.968 0.524 0.974</span></span>
<span><span class="co">## [4,] 0.000 0.000 0.000 0.000 0.000 0.000 0.000  0.000 0.000 3.837 0.000 0.000</span></span>
<span><span class="co">##      [,13]  [,14] [,15] [,16]   [,17] [,18]   [,19] [,20]  [,21] [,22]</span></span>
<span><span class="co">## [1,]     0 47.494 3.094 0.000   0.000 0.000 100.000 13.24  0.000     0</span></span>
<span><span class="co">## [2,]   100  0.000 0.000 4.565   0.000 0.000  40.643  0.00  0.000     0</span></span>
<span><span class="co">## [3,]     0  0.000 0.000 0.000 100.000 0.000   0.000  0.00 40.994     0</span></span>
<span><span class="co">## [4,]     0  0.000 0.000 0.000  32.341 1.374   0.000  0.00  0.000   100</span></span></code></pre>
<p>The associated m/z values for the bins can be extracted with
<code><a href="../reference/spectraData.html">mz()</a></code> from the binned <code>Spectra</code> object. Below we
use these as column names for the intensity matrix.</p>
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">intmat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spectraData.html">mz</a></span><span class="op">(</span><span class="va">sps_bin</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="op">!</span><span class="va">zeros</span><span class="op">]</span></span></code></pre></div>
<p>This intensity matrix could now for example be used to cluster the
spectra based on their peak intensities.</p>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/heatmap.html" class="external-link">heatmap</a></span><span class="op">(</span><span class="va">intmat</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spectra_files/figure-html/unnamed-chunk-29-1.png" width="700"></p>
<p>As expected, the first 2 and the last 2 spectra are more similar and
are clustered together.</p>
</div>
<div class="section level3">
<h3 id="exporting-spectra">Exporting spectra<a class="anchor" aria-label="anchor" href="#exporting-spectra"></a>
</h3>
<p>Spectra data can be exported with the <code><a href="../reference/Spectra.html">export()</a></code> method.
This method takes the <code>Spectra</code> that is supposed to be
exported and the backend (parameter <code>backend</code>) which should
be used to export the data and additional parameters for the export
function of this backend. The backend thus defines the format of the
exported file. Note however that not all <code>MsBackend</code> classes
might support data export. The backend classes currently supporting data
export and its format are: - <code>MsBackendMzR</code>
(<code>Spectra</code> package): export data in <em>mzML</em> and
<em>mzXML</em> format. Can not export all custom, user specified spectra
variables. - <code>MsBackendMgf</code> (<a href="https://RforMassSpectrometry.github.io/MsBackendMgf" class="external-link"><code>MsBackendMgf</code></a>
package): exports data in <em>Mascot Generic Format</em> (mgf). Exports
all spectra variables as individual spectrum fields in the mgf file. -
<code>MsBackendMsp</code> (<a href="https://RforMassSpectrometry.github.io/MsBackendMsp" class="external-link"><code>MsBackendMsp</code></a>):
exports data in NIST MSP format. - <code>MsBackendMassbank</code> (<a href="https://RforMassSpectrometry.github.io/MsBackendMassbank" class="external-link"><code>MsBackendMassbank</code></a>)
exports data in Massbank text file format.</p>
<p>In the example below we use the <code>MsBackendMzR</code> to export
all spectra from the variable <code>sps</code> to an mzML file. We thus
pass the data, the backend that should be used for the export and the
file name of the result file (a temporary file) to the
<code><a href="../reference/Spectra.html">export()</a></code> function (see also the help page of the
<code>export,MsBackendMzR</code> function for additional supported
parameters).</p>
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/Spectra.html">export</a></span><span class="op">(</span><span class="va">sps</span>, <span class="fu"><a href="../reference/MsBackend.html">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span>, file <span class="op">=</span> <span class="va">fl</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Writing file file1c694ae2de6a...OK</span></span></code></pre>
<p>To evaluate which of the spectra variables were exported, we load the
exported data again and identify spectra variables in the original file
which could not be exported (because they are not defined variables in
the mzML standard).</p>
<div class="sourceCode" id="cb157"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_im</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Spectra.html">Spectra</a></span><span class="op">(</span><span class="fu"><a href="../reference/MsBackend.html">backendInitialize</a></span><span class="op">(</span><span class="fu"><a href="../reference/MsBackend.html">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">fl</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/spectraData.html">spectraVariables</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="../reference/spectraData.html">spectraVariables</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="../reference/spectraData.html">spectraVariables</a></span><span class="op">(</span><span class="va">sps_im</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "id"         "name"       "splash"     "instrument"</span></span></code></pre>
<p>These additional variables were thus not exported. How data export is
performed and handled depends also on the used backend. The
<code>MsBackendMzR</code> for example exports all spectra by default to
a single file (specified with the <code>file</code> parameter), but it
allows also to specify for each individual spectrum in the
<code>Spectra</code> to which file it should be exported (parameter
<code>file</code> has thus to be of length equal to the number of
spectra). As an example we export below the spectrum 1 and 3 to one file
and spectra 2 and 4 to another.</p>
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/Spectra.html">export</a></span><span class="op">(</span><span class="va">sps</span>, <span class="fu"><a href="../reference/MsBackend.html">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span>, file <span class="op">=</span> <span class="va">fls</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Writing file file1c695d4b65b5...OK</span></span>
<span><span class="co">## Writing file file1c695333b2e1...OK</span></span></code></pre>
<p>A more realistic use case for mzML export would be to export MS data
after processing, such as smoothing (using the <code><a href="../reference/addProcessing.html">smooth()</a></code>
function) and centroiding (using the <code><a href="../reference/addProcessing.html">pickPeaks()</a></code> function)
of raw profile-mode MS data.</p>
</div>
<div class="section level3">
<h3 id="changing-backends">Changing backends<a class="anchor" aria-label="anchor" href="#changing-backends"></a>
</h3>
<p>In the previous sections we learned already that a
<code>Spectra</code> object can use different backends for the actual
data handling. It is also possible to change the backend of a
<code>Spectra</code> to a different one with the
<code><a href="../reference/Spectra.html">setBackend()</a></code> function. We could for example change the
(<code>MsBackendMzR</code>) backend of the <code>sps_sciex</code> object
to a <code>MsBackendMemory</code> backend to enable use of the data even
without the need to keep the original mzML files. Below we change the
backend of <code>sps_sciex</code> to the in-memory
<code>MsBackendMemory</code> backend.</p>
<div class="sourceCode" id="cb161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"Mb"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 0.4 Mb</span></span></code></pre>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_sciex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Spectra.html">setBackend</a></span><span class="op">(</span><span class="va">sps_sciex</span>, <span class="fu"><a href="../reference/MsBackend.html">MsBackendMemory</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps_sciex</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 1862 spectra in a MsBackendMemory backend:</span></span>
<span><span class="co">##        msLevel     rtime scanIndex</span></span>
<span><span class="co">##      &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1            1     0.280         1</span></span>
<span><span class="co">## 2            1     0.559         2</span></span>
<span><span class="co">## 3            1     0.838         3</span></span>
<span><span class="co">## 4            1     1.117         4</span></span>
<span><span class="co">## 5            1     1.396         5</span></span>
<span><span class="co">## ...        ...       ...       ...</span></span>
<span><span class="co">## 1858         1   258.636       927</span></span>
<span><span class="co">## 1859         1   258.915       928</span></span>
<span><span class="co">## 1860         1   259.194       929</span></span>
<span><span class="co">## 1861         1   259.473       930</span></span>
<span><span class="co">## 1862         1   259.752       931</span></span>
<span><span class="co">##  ... 34 more variables/columns.</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Switch backend from MsBackendMzR to MsBackendMemory [Thu Aug 28 08:26:17 2025]</span></span></code></pre>
<p>With the call the full peak data was imported from the original mzML
files into the object. This has obviously an impact on the object’s
size, which is now much larger than before.</p>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"Mb"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 53.2 Mb</span></span></code></pre>
<p>The <code>dataStorage</code> spectrum variable has now changed, while
<code>dataOrigin</code> still keeps the information about the
originating files:</p>
<div class="sourceCode" id="cb167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/spectraData.html">dataStorage</a></span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "&lt;memory&gt;" "&lt;memory&gt;" "&lt;memory&gt;" "&lt;memory&gt;" "&lt;memory&gt;" "&lt;memory&gt;"</span></span></code></pre>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/path.html" class="external-link">basename</a></span><span class="op">(</span><span class="fu"><a href="../reference/spectraData.html">dataOrigin</a></span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"</span></span>
<span><span class="co">## [3] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"</span></span>
<span><span class="co">## [5] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="backends">Backends<a class="anchor" aria-label="anchor" href="#backends"></a>
</h2>
<p>Backends allow to use different <em>backends</em> to store mass
spectrometry data while providing <em>via</em> the <code>Spectra</code>
class a unified interface to use that data. This is a further
abstraction to the <em>on-disk</em> and <em>in-memory</em> data modes
from <code>MSnbase</code> <span class="citation">(Gatto, Gibb, and
Rainer 2020)</span>. The <code>Spectra</code> package defines a set of
example backends but any object extending the base
<code>MsBackend</code> class could be used instead. The default backends
are:</p>
<ul>
<li><p><code>MsBackendMemory</code>: the <em>default</em> backend to
store data in memory. Due to its design the <code>MsBackendMemory</code>
provides fast access to the peaks matrices (using the
<code><a href="../reference/spectraData.html">peaksData()</a></code> function) and is also optimized for fast access
to spectra variables and subsetting. Since all data is kept in memory,
this backend has a relatively large memory footprint (depending on the
data) and is thus not suggested for very large MS experiments.</p></li>
<li><p><code>MsBackendDataFrame</code>: the mass spectrometry data is
stored (in-memory) in a <code>DataFrame</code>. Keeping the data in
memory guarantees high performance but has also, depending on the number
of mass peaks in each spectrum, a much higher memory footprint.</p></li>
<li><p><code>MsBackendMzR</code>: this backend keeps only general
spectra variables in memory and relies on the <em><a href="https://bioconductor.org/packages/3.22/mzR" class="external-link">mzR</a></em> package
to read mass peaks (m/z and intensity values) from the original MS files
on-demand.</p></li>
<li><p><code>MsBackendHdf5Peaks</code>: similar to
<code>MsBackendMzR</code> this backend reads peak data only on-demand
from disk while all other spectra variables are kept in memory. The peak
data are stored in Hdf5 files which guarantees scalability.</p></li>
</ul>
<p>All of the above mentioned backends support changing all of their
their spectra variables, <strong>except</strong> the
<code>MsBackendMzR</code> that does not support changing m/z or
intensity values for the mass peaks.</p>
<p>With the example below we load the data from a single mzML file and
use a <code>MsBackendHdf5Peaks</code> backend for data storage. The
<code>hdf5path</code> parameter allows us to specify the storage
location of the HDF5 file.</p>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">msdata</span><span class="op">)</span></span>
<span><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/msdata/man/proteomics.html" class="external-link">proteomics</a></span><span class="op">(</span>full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span></span>
<span></span>
<span><span class="va">sps_tmt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Spectra.html">Spectra</a></span><span class="op">(</span><span class="va">fl</span>, backend <span class="op">=</span> <span class="fu"><a href="../reference/MsBackend.html">MsBackendHdf5Peaks</a></span><span class="op">(</span><span class="op">)</span>, hdf5path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/path.html" class="external-link">basename</a></span><span class="op">(</span><span class="fu"><a href="../reference/spectraData.html">dataStorage</a></span><span class="op">(</span><span class="va">sps_tmt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.h5"</span></span>
<span><span class="co">## [2] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.h5"</span></span>
<span><span class="co">## [3] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.h5"</span></span>
<span><span class="co">## [4] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.h5"</span></span>
<span><span class="co">## [5] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.h5"</span></span>
<span><span class="co">## [6] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.h5"</span></span></code></pre>
<p>A (possibly incomplete) list of R packages providing additional
backends that add support for additional data types or storage options
is provided below:</p>
<ul>
<li><p><code>MsBackendCompDb</code> (package <em><a href="https://bioconductor.org/packages/3.22/CompoundDb" class="external-link">CompoundDb</a></em>):
provides access to spectra data (spectra and peaks variables) from a
<em>CompDb</em> database. Has a small memory footprint because all data
(except precursor m/z values) are retrieved on-the-fly from the
database.</p></li>
<li><p><code>MsBackendHmdbXml</code> (package <a href="https://github.com/rformassspectrometry/MsBackendHmdb" class="external-link"><code>MsbackendHmdb</code></a>):
allows import of MS data from xml files of the Human Metabolome Database
(HMDB). Extends the <code>MsBackendDataFrame</code> and keeps thus all
data, after import, in memory.</p></li>
<li><p><code>MsBackendMassbank</code> (package <em><a href="https://bioconductor.org/packages/3.22/MsBackendMassbank" class="external-link">MsBackendMassbank</a></em>):
allows to import/export data in MassBank text file format. Extends the
<code>MsBackendDataFrame</code> and keeps thus all data, after import,
in memory.</p></li>
<li><p><code>MsBackendMassbankSql</code> (package <em><a href="https://bioconductor.org/packages/3.22/MsBackendMassbank" class="external-link">MsBackendMassbank</a></em>):
allows to directly connect to a MassBank SQL database to retrieve all MS
data and variables. Has a minimal memory footprint because all data is
retrieved on-the-fly from the SQL database.</p></li>
<li><p><code>MsBackendMetaboLights</code> (package
<code>r BiocStyle::Biocpkg("MsBackendMetaboLights")</code>): retrieves
and caches MS data files from the MetaboLights repository.</p></li>
<li><p><code>MsBackendMgf</code>: (package <em><a href="https://bioconductor.org/packages/3.22/MsBackendMgf" class="external-link">MsBackendMgf</a></em>):
support for import/export of mass spectrometry files in mascot generic
format (MGF).</p></li>
<li><p><code>MsBackendMsp</code>: (package <em><a href="https://bioconductor.org/packages/3.22/MsBackendMsp" class="external-link">MsBackendMsp</a></em>):
allows to import/export data in NIST MSP format. Extends the
<code>MsBackendDataFrame</code> and keeps thus all data, after import,
in memory.</p></li>
<li><p><code>MsBackendRawFileReader</code> (package <em><a href="https://bioconductor.org/packages/3.22/MsBackendRawFileReader" class="external-link">MsBackendRawFileReader</a></em>):
implements a backend for reading MS data from Thermo Fisher Scientific’s
raw data files using the manufacturer’s NewRawFileReader .Net libraries.
The package generalizes the functionality introduced by the <em><a href="https://bioconductor.org/packages/3.22/rawrr" class="external-link">rawrr</a></em>
package, see also <span class="citation">(Kockmann and Panse
2021)</span>.</p></li>
<li><p><code>MsBackendSql</code> (package <em><a href="https://bioconductor.org/packages/3.22/MsBackendSql" class="external-link">MsBackendSql</a></em>):
stores all MS data in a SQL database and has thus a minimal memory
footprint.</p></li>
<li><p><code>MsBackendTimsTof</code> (package <a href="https://github.com/rformassspectrometry/MsBackendTimsTof" class="external-link"><code>MsBackendTimsTof</code></a>:
allows import of data from Bruker TimsTOF raw data files (using the
<code>opentimsr</code> R package).</p></li>
<li><p><code>MsBackendWeizMass</code> (package <a href="https://github.com/rformassspectrometry/MsBackendWeizMass" class="external-link"><code>MsBackendWeizMass</code></a>:
allows to access MS data from WeizMass MS/MS spectral
databases.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="handling-very-large-data-sets">Handling very large data sets<a class="anchor" aria-label="anchor" href="#handling-very-large-data-sets"></a>
</h2>
<p>The <code>Spectra</code> package was designed to support also
efficient processing of very large data sets. Most of the functionality
do not require to keep the full MS data in memory (specifically, the
peaks data, i.e., m/z and intensity values, which represent the largest
chunk of data for MS experiments). For some functions however the peaks
data needs to be loaded into memory. One such example is the
<code><a href="../reference/spectraData.html">lengths()</a></code> function to determine the number of peaks per
spectra that is calculated (on the fly) by evaluating the number of rows
of the peaks matrix. Backends such as the <code>MsBackendMzR</code>
perform by default any data processing separately (and eventually in
parallel) by data file and it should thus be safe to call any such
functions on a <code>Spectra</code> object with that backend. For other
backends (such as the <a href="https://github.com/RforMassSpectrometry/MsBackendSql" class="external-link"><code>MsBackendSql</code></a>
or the <a href="https://github.com/RforMassSpectrometry/MsBackendMassbank" class="external-link"><code>MsBackendMassbankSql</code></a>)
it is however advised to process the data in a <em>chunk-wise</em>
manner using the <code><a href="../reference/addProcessing.html">spectrapply()</a></code> function with parameter
<code>chunkSize</code>. This will split the original
<code>Spectra</code> object into chunks of size <code>chunkSize</code>
and applies the function separately to each chunk. That way only data
from one chunk will eventually be loaded into memory in each iteration
enabling to process also very large <code>Spectra</code> objects on
computers with limited hardware resources. Instead of a
<code>lengths(sps)</code> call, the number of peaks per spectra could
also be determined (in a less memory demanding way) with
<code>spectrapply(sps, lengths, chunkSize = 5000L)</code>. In that way
only peak data of 5000 spectra at a time will be loaded into memory.</p>
</div>
<div class="section level2">
<h2 id="serializing-saving-moving-and-loading-serialized-spectra-objects">Serializing (saving), moving and loading serialized
<code>Spectra</code> objects<a class="anchor" aria-label="anchor" href="#serializing-saving-moving-and-loading-serialized-spectra-objects"></a>
</h2>
<p>Serializing and re-loading variables/objects during an analysis using
e.g. the <code><a href="https://rdrr.io/r/base/save.html" class="external-link">save()</a></code> and <code><a href="https://rdrr.io/r/base/load.html" class="external-link">load()</a></code> functions are
common in many workflows, especially if some of the tasks are
computationally intensive and take long time. Sometimes such serialized
objects might even be moved from one computer (or file system) to
another. These operations are unproblematic for <code>Spectra</code>
objects with <em>in-memory</em> backends such as the
<code>MsBackendMemory</code> or <code>MsBackendDataFrame</code>, that
keep all data in memory, would however break for <em>on-disk</em>
backends such as the <code>MsBackendMzR</code> if the file path to the
original data files is not identical. It is thus suggested (if the size
of the MS data respectively the available system memory allows it) to
change the backend for such <code>Spectra</code> objects to a
<code>MsBackendMemory</code> before serializing the object with
<code><a href="https://rdrr.io/r/base/save.html" class="external-link">save()</a></code>. For <code>Spectra</code> objects with a
<code>MsBackendMzR</code> an alternative option would be to eventually
update/adapt the path to the directory containing the raw (e.g. mzML)
data files: assuming these data files are available on both computers,
the path to the directory containing these can be updated with the
<code>dataStorageBasePath&lt;-</code> function allowing thus to
move/copy serialized <code>Spectra</code> objects between computers or
file systems.</p>
<p>An example workflow could be:</p>
<p>files <em>a.mzML</em>, <em>b.mzML</em> are stored in a directory
<em>/data/mzML/</em> on one computer. These get loaded as a
<code>Spectra</code> object with <code>MsBackendMzR</code> and then
serialized to a file <em>A.RData</em>.</p>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Spectra.html">Spectra</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"/data/mzML/a.mzML"</span>, <span class="st">"/data/mzML/b.mzML"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">A</span>, file <span class="op">=</span> <span class="st">"A.RData"</span><span class="op">)</span></span></code></pre></div>
<p>Assuming this file gets now copied to another computer (where the
data is not available in a folder <em>/data/mzML/</em>) and loaded with
<code><a href="https://rdrr.io/r/base/load.html" class="external-link">load()</a></code>.</p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"A.RData"</span><span class="op">)</span></span></code></pre></div>
<p>This <code>Spectra</code> object would not be valid because its
<code>MsBackendMzR</code> can no longer access the MS data in the
original data files. Assuming the user also copied the data files
<em>a.mzML</em> and <em>b.mzML</em>, but to a folder
<em>/some_other_folder/</em>, the base storage path of the object would
need to be adapted to match the directory where the data files are
available on the second computer:</p>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/MsBackend.html">dataStorageBasePath</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"/some_other_folder"</span></span></code></pre></div>
<p>By pointing now the storage path to the new storage location of the
data files, the <code>Spectra</code> object <code>A</code> would also be
usable on the second computer.</p>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.5.1 (2025-06-13)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">## Running under: Ubuntu 24.04.2 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span><span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] msdata_0.49.0       msentropy_0.1.4     Rcpp_1.1.0         </span></span>
<span><span class="co">##  [4] MsCoreUtils_1.21.0  Spectra_1.19.7      BiocParallel_1.43.4</span></span>
<span><span class="co">##  [7] S4Vectors_0.47.0    BiocGenerics_0.55.1 generics_0.1.4     </span></span>
<span><span class="co">## [10] BiocStyle_2.37.1   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] jsonlite_2.0.0         compiler_4.5.1         BiocManager_1.30.26   </span></span>
<span><span class="co">##  [4] Biobase_2.69.0         rhdf5filters_1.21.0    parallel_4.5.1        </span></span>
<span><span class="co">##  [7] cluster_2.1.8.1        jquerylib_0.1.4        systemfonts_1.2.3     </span></span>
<span><span class="co">## [10] IRanges_2.43.0         textshaping_1.0.1      yaml_2.3.10           </span></span>
<span><span class="co">## [13] fastmap_1.2.0          R6_2.6.1               ProtGenerics_1.41.0   </span></span>
<span><span class="co">## [16] knitr_1.50             htmlwidgets_1.6.4      MASS_7.3-65           </span></span>
<span><span class="co">## [19] bookdown_0.44          desc_1.4.3             bslib_0.9.0           </span></span>
<span><span class="co">## [22] rlang_1.1.6            cachem_1.1.0           xfun_0.53             </span></span>
<span><span class="co">## [25] fs_1.6.6               sass_0.4.10            cli_3.6.5             </span></span>
<span><span class="co">## [28] Rhdf5lib_1.31.0        pkgdown_2.1.3.9000     ncdf4_1.24            </span></span>
<span><span class="co">## [31] digest_0.6.37          mzR_2.43.1             MetaboCoreUtils_1.17.1</span></span>
<span><span class="co">## [34] rhdf5_2.53.4           lifecycle_1.0.4        clue_0.3-66           </span></span>
<span><span class="co">## [37] evaluate_1.0.4         codetools_0.2-20       ragg_1.4.0            </span></span>
<span><span class="co">## [40] rmarkdown_2.29         tools_4.5.1            htmltools_0.5.8.1</span></span></code></pre>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-gattoMSnbaseEfficientElegant2020a" class="csl-entry">
Gatto, Laurent, Sebastian Gibb, and Johannes Rainer. 2020.
<span>“<span>MSnbase</span>, <span>Efficient</span> and <span>Elegant
R</span>-<span>Based Processing</span> and <span>Visualization</span> of
<span>Raw Mass Spectrometry Data</span>.”</span> <em>Journal of Proteome
Research</em>, September. <a href="https://doi.org/10.1021/acs.jproteome.0c00313" class="external-link">https://doi.org/10.1021/acs.jproteome.0c00313</a>.
</div>
<div id="ref-kockmann_rawrr_2021" class="csl-entry">
Kockmann, Tobias, and Christian Panse. 2021. <span>“<span class="nocase">The rawrr <span>R</span> Package: Direct Access to
Orbitrap Data and Beyond</span>.”</span> <em>Journal of Proteome
Research</em>. <a href="https://doi.org/10.1021/acs.jproteome.0c00866" class="external-link">https://doi.org/10.1021/acs.jproteome.0c00866</a>.
</div>
<div id="ref-rainer_modular_2022" class="csl-entry">
Rainer, Johannes, Andrea Vicini, Liesa Salzer, Jan Stanstrup, Josep M.
Badia, Steffen Neumann, Michael A. Stravs, et al. 2022. <span>“A
<span>Modular</span> and <span>Expandable</span> <span>Ecosystem</span>
for <span>Metabolomics</span> <span>Data</span> <span>Annotation</span>
in <span>R</span>.”</span> <em>Metabolites</em> 12 (2): 173. <a href="https://doi.org/10.3390/metabo12020173" class="external-link">https://doi.org/10.3390/metabo12020173</a>.
</div>
<div id="ref-y_spectral_2021" class="csl-entry">
Y, Li, Kind T, Folz J, Vaniya A, Mehta Ss, and Fiehn O. 2021.
<span>“Spectral Entropy Outperforms <span>MS</span>/<span>MS</span> Dot
Product Similarity for Small-Molecule Compound Identification.”</span>
<em>Nature Methods</em> 18 (12). <a href="https://doi.org/10.1038/s41592-021-01331-z" class="external-link">https://doi.org/10.1038/s41592-021-01331-z</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by RforMassSpectrometry Package Maintainer, Laurent Gatto, Johannes Rainer, Sebastian Gibb, Philippine Louail.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
