<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Description and usage of Spectra objects • Spectra</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Description and usage of Spectra objects">
<meta property="og:description" content="Spectra">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Spectra</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.10</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/Spectra.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/RforMassSpectrometry/Spectra/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Spectra_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Description and usage of Spectra objects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/RforMassSpectrometry/Spectra/blob/master/vignettes/Spectra.Rmd"><code>vignettes/Spectra.Rmd</code></a></small>
      <div class="hidden name"><code>Spectra.Rmd</code></div>

    </div>

    
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><p><strong>Package</strong>: <em><a href="https://bioconductor.org/packages/3.13/Spectra">Spectra</a></em><br><strong>Authors</strong>: RforMassSpectrometry Package Maintainer [cre], Laurent Gatto [aut] (<a href="https://orcid.org/0000-0002-1520-2268" class="uri">https://orcid.org/0000-0002-1520-2268</a>), Johannes Rainer [aut] (<a href="https://orcid.org/0000-0002-6977-7147" class="uri">https://orcid.org/0000-0002-6977-7147</a>), Sebastian Gibb [aut] (<a href="https://orcid.org/0000-0001-7406-4443" class="uri">https://orcid.org/0000-0001-7406-4443</a>)<br><strong>Last modified:</strong> 2020-12-08 14:08:05<br><strong>Compiled</strong>: Tue Dec 8 14:27:28 2020</p>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The <code>Spectra</code> package provides a scalable and flexible infrastructure to represent, retrieve and handle mass spectrometry (MS) data. The <code>Spectra</code> object provides the user with a single standardized interface to access and manipulate MS data while supporting, through the concept of exchangeable <em>backends</em>, a large variety of different ways to store and retrieve mass spectrometry data. Such backends range from mzML/mzXML/CDF files, simple flat files, or database systems.</p>
</div>
<div id="installation" class="section level1">
<h1 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h1>
<p>The package can be installed with the <code>BiocManager</code> package. To install <code>BiocManager</code> use <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages("BiocManager")</a></code> and, after that, <code><a href="https://rdrr.io/pkg/BiocManager/man/install.html">BiocManager::install("Spectra")</a></code> to install <code>Spectra</code>.</p>
</div>
<div id="general-usage" class="section level1">
<h1 class="hasAnchor">
<a href="#general-usage" class="anchor"></a>General usage</h1>
<p>Mass spectrometry data in <code>Spectra</code> objects can be thought of as a list of individual spectra, with each spectrum having a set of variables associated with it. Besides <em>core</em> spectra variables (such as MS level or retention time) an arbitrary number of optional variables can be assigned to a spectrum. The core spectra variables all have their own accessor method and it is guaranteed that a value is returned by it (or <code>NA</code> if the information is not available). The core variables and their data type are (alphabetically ordered):</p>
<ul>
<li>
<em>acquisitionNum</em> <code><a href="https://rdrr.io/r/base/integer.html">integer(1)</a></code>: the index of acquisition of a spectrum during a MS run.</li>
<li>
<em>centroided</em> <code><a href="https://rdrr.io/r/base/logical.html">logical(1)</a></code>: whether the spectrum is in profile or centroid mode.</li>
<li>
<em>collisionEnergy</em> <code><a href="https://rdrr.io/r/base/numeric.html">numeric(1)</a></code>: collision energy used to create an MSn spectrum.</li>
<li>
<em>dataOrigin</em> <code><a href="https://rdrr.io/r/base/character.html">character(1)</a></code>: the <em>origin</em> of the spectrum’s data, e.g. the mzML file from which it was read.</li>
<li>
<em>dataStorage</em> <code><a href="https://rdrr.io/r/base/character.html">character(1)</a></code>: the (current) storage location of the spectrum data. This value depends on the backend used to handle and provide the data. For an <em>in-memory</em> backend like the <code>MsBackendDataFrame</code> this will be <code>"&lt;memory&gt;"</code>, for an on-disk backend such as the <code>MsBackendHdf5Peaks</code> it will be the name of the HDF5 file where the spectrum’s peak data is stored.</li>
<li>
<em>intensity</em> <code>numeric</code>: intensity values for the spectrum’s peaks.</li>
<li>
<em>isolationWindowLowerMz</em> <code><a href="https://rdrr.io/r/base/numeric.html">numeric(1)</a></code>: lower m/z for the isolation window in which the (MSn) spectrum was measured.</li>
<li>
<em>isolationWindowTargetMz</em> <code><a href="https://rdrr.io/r/base/numeric.html">numeric(1)</a></code>: the target m/z for the isolation window in which the (MSn) spectrum was measured.</li>
<li>
<em>isolationWindowUpperMz</em> <code><a href="https://rdrr.io/r/base/numeric.html">numeric(1)</a></code>: upper m/z for the isolation window in which the (MSn) spectrum was measured.</li>
<li>
<em>msLevel</em> <code><a href="https://rdrr.io/r/base/integer.html">integer(1)</a></code>: the MS level of the spectrum.</li>
<li>
<em>mz</em> <code>numeric</code>: the m/z values for the spectrum’s peaks.</li>
<li>
<em>polarity</em> <code><a href="https://rdrr.io/r/base/integer.html">integer(1)</a></code>: the polarity of the spectrum (<code>0</code> and <code>1</code> representing negative and positive polarity, respectively).</li>
<li>
<em>precScanNum</em> <code><a href="https://rdrr.io/r/base/integer.html">integer(1)</a></code>: the scan (acquisition) number of the precursor for an MSn spectrum.</li>
<li>
<em>precursorCharge</em> <code><a href="https://rdrr.io/r/base/integer.html">integer(1)</a></code>: the charge of the precursor of an MSn spectrum.</li>
<li>
<em>precursorIntensity</em> <code><a href="https://rdrr.io/r/base/numeric.html">numeric(1)</a></code>: the intensity of the precursor of an MSn spectrum.</li>
<li>
<em>precursorMz</em> <code><a href="https://rdrr.io/r/base/numeric.html">numeric(1)</a></code>: the m/z of the precursor of an MSn spectrum.</li>
<li>
<em>rtime</em> <code><a href="https://rdrr.io/r/base/numeric.html">numeric(1)</a></code>: the retention time of a spectrum.</li>
<li>
<em>scanIndex</em> <code><a href="https://rdrr.io/r/base/integer.html">integer(1)</a></code>: the index of a spectrum within a (raw) file.</li>
<li>
<em>smoothed</em> <code><a href="https://rdrr.io/r/base/logical.html">logical(1)</a></code>: whether the spectrum was smoothed.</li>
</ul>
<p>For details on the individual variables and their getter/setter function see the help for <code>Spectra</code> (<code><a href="../reference/addProcessing.html">?Spectra</a></code>). Also note that these variables are suggested, but not required to characterize a spectrum. Also, some only make sense for MSn, but not for MS1 spectra.</p>
<div id="creating-spectra-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-spectra-objects" class="anchor"></a>Creating <code>Spectra</code> objects</h2>
<p>The simplest way to create a <code>Spectra</code> object is by defining a <code>DataFrame</code> with the corresponding spectra data (using the corresponding spectra variable names as column names) and passing that to the <code>Spectra</code> constructor function. Below we create such an object for a set of 3 spectra providing their MS level, polarity but also additional annotations such as their ID in <a href="http://hmdb.ca">HMDB</a> (human metabolome database) and their name. The m/z and intensity values for each spectrum have to be provided as a <code>list</code> of <code>numeric</code> values.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra">Spectra</a></span><span class="op">)</span>

<span class="va">spd</span> <span class="op">&lt;-</span> <span class="fu">DataFrame</span><span class="op">(</span>
    msLevel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>,
    polarity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span>, <span class="fl">1L</span><span class="op">)</span>,
    id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"HMDB0000001"</span>, <span class="st">"HMDB0000001"</span>, <span class="st">"HMDB0001847"</span><span class="op">)</span>,
    name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1-Methylhistidine"</span>, <span class="st">"1-Methylhistidine"</span>, <span class="st">"Caffeine"</span><span class="op">)</span><span class="op">)</span>

<span class="co">## Assign m/z and intensity values.</span>
<span class="va">spd</span><span class="op">$</span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">109.2</span>, <span class="fl">124.2</span>, <span class="fl">124.5</span>, <span class="fl">170.16</span>, <span class="fl">170.52</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">83.1</span>, <span class="fl">96.12</span>, <span class="fl">97.14</span>, <span class="fl">109.14</span>, <span class="fl">124.08</span>, <span class="fl">125.1</span>, <span class="fl">170.16</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">56.0494</span>, <span class="fl">69.0447</span>, <span class="fl">83.0603</span>, <span class="fl">109.0395</span>, <span class="fl">110.0712</span>,
      <span class="fl">111.0551</span>, <span class="fl">123.0429</span>, <span class="fl">138.0662</span>, <span class="fl">195.0876</span><span class="op">)</span><span class="op">)</span>
<span class="va">spd</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.407</span>, <span class="fl">47.494</span>, <span class="fl">3.094</span>, <span class="fl">100.0</span>, <span class="fl">13.240</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6.685</span>, <span class="fl">4.381</span>, <span class="fl">3.022</span>, <span class="fl">16.708</span>, <span class="fl">100.0</span>, <span class="fl">4.565</span>, <span class="fl">40.643</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.459</span>, <span class="fl">2.585</span>, <span class="fl">2.446</span>, <span class="fl">0.508</span>, <span class="fl">8.968</span>, <span class="fl">0.524</span>, <span class="fl">0.974</span>, <span class="fl">100.0</span>, <span class="fl">40.994</span><span class="op">)</span><span class="op">)</span>

<span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">Spectra</a></span><span class="op">(</span><span class="va">spd</span><span class="op">)</span>
<span class="va">sps</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 3 spectra in a MsBackendDataFrame backend:
##     msLevel     rtime scanIndex
##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1         2        NA        NA
## 2         2        NA        NA
## 3         2        NA        NA
##  ... 18 more variables/columns.</code></pre>
<p>Alternatively, it is possible to import spectra data from mass spectrometry raw files in mzML/mzXML or CDF format. Below we create a <code>Spectra</code> object from two mzML files and define to use a <code>MsBackendMzR</code> backend to <em>store</em> the data (note that this requires the <em><a href="https://bioconductor.org/packages/3.13/mzR">mzR</a></em> package to be installed). This backend, specifically designed for raw MS data, keeps only a subset of spectra variables in memory while reading the m/z and intensity values from the original data files only on demand. See section <a href="#backends">Backends</a> for more details on backends and their properties.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"sciex"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">sps_sciex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">Spectra</a></span><span class="op">(</span><span class="va">fls</span>, backend <span class="op">=</span> <span class="fu"><a href="../reference/MsBackend.html">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">sps_sciex</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 1862 spectra in a MsBackendMzR backend:
##        msLevel     rtime scanIndex
##      &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1            1     0.280         1
## 2            1     0.559         2
## 3            1     0.838         3
## 4            1     1.117         4
## 5            1     1.396         5
## ...        ...       ...       ...
## 1858         1   258.636       927
## 1859         1   258.915       928
## 1860         1   259.194       929
## 1861         1   259.473       930
## 1862         1   259.752       931
##  ... 33 more variables/columns.
## 
## file(s):
## 20171016_POOL_POS_1_105-134.mzML
## 20171016_POOL_POS_3_105-134.mzML</code></pre>
<p>The <code>Spectra</code> object <code>sps_sciex</code> allows now to access spectra data from 1862 MS1 spectra and uses <code>MsBackendMzR</code> as backend (the <code>Spectra</code> object <code>sps</code> created in the previous code block uses the default <code>MsBackendDataFrame</code>).</p>
</div>
<div id="accessing-spectrum-data" class="section level2">
<h2 class="hasAnchor">
<a href="#accessing-spectrum-data" class="anchor"></a>Accessing spectrum data</h2>
<p>As detailed above <code>Spectra</code> objects can contain an arbitrary number of properties of a spectrum (so called <em>spectra variables</em>). The available variables can be listed with the <code>spectraVariables</code> method:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">spectraVariables</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "msLevel"                 "rtime"                  
##  [3] "acquisitionNum"          "scanIndex"              
##  [5] "dataStorage"             "dataOrigin"             
##  [7] "centroided"              "smoothed"               
##  [9] "polarity"                "precScanNum"            
## [11] "precursorMz"             "precursorIntensity"     
## [13] "precursorCharge"         "collisionEnergy"        
## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"
## [17] "isolationWindowUpperMz"  "id"                     
## [19] "name"</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">spectraVariables</span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "msLevel"                  "rtime"                   
##  [3] "acquisitionNum"           "scanIndex"               
##  [5] "dataStorage"              "dataOrigin"              
##  [7] "centroided"               "smoothed"                
##  [9] "polarity"                 "precScanNum"             
## [11] "precursorMz"              "precursorIntensity"      
## [13] "precursorCharge"          "collisionEnergy"         
## [15] "isolationWindowLowerMz"   "isolationWindowTargetMz" 
## [17] "isolationWindowUpperMz"   "peaksCount"              
## [19] "totIonCurrent"            "basePeakMZ"              
## [21] "basePeakIntensity"        "ionisationEnergy"        
## [23] "lowMZ"                    "highMZ"                  
## [25] "mergedScan"               "mergedResultScanNum"     
## [27] "mergedResultStartScanNum" "mergedResultEndScanNum"  
## [29] "injectionTime"            "filterString"            
## [31] "spectrumId"               "ionMobilityDriftTime"    
## [33] "scanWindowLowerLimit"     "scanWindowUpperLimit"</code></pre>
<p>The two <code>Spectra</code> contain a different set of variables: besides <code>"msLevel"</code>, <code>"polarity"</code>, <code>"id"</code> and <code>"name"</code>, that were specified for the <code>Spectra</code> object <code>sps</code>, it contains more variables such as <code>"rtime"</code>, <code>"acquisitionNum"</code> and <code>"scanIndex"</code>. These are part of the <em>core variables</em> defining a spectrum and for all of these accessor methods exist. Below we use <code>msLevel</code> and <code>rtime</code> to access the MS levels and retention times for the spectra in <code>sps</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">msLevel</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 2 2 2</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">rtime</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] NA NA NA</code></pre>
<p>We did not specify retention times for the spectra in <code>sps</code> thus <code>NA</code> is returned for them. The <code>Spectra</code> object <code>sps_sciex</code> contains many more variables, all of which were extracted from the mzML files. Below we extract the retention times for the first spectra in the object.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">rtime</span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.280 0.559 0.838 1.117 1.396 1.675</code></pre>
<p>Note that in addition to the accessor functions it is also possible to use <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> to extract a specific spectra variable. To extract the name of the compounds in <code>sps</code> we can use <code>sps$name</code>, or, to extract the MS levels <code>sps$msLevel</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps</span><span class="op">$</span><span class="va">name</span></code></pre></div>
<pre><code>## [1] "1-Methylhistidine" "1-Methylhistidine" "Caffeine"</code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps</span><span class="op">$</span><span class="va">msLevel</span></code></pre></div>
<pre><code>## [1] 2 2 2</code></pre>
<p>We could also replace specific spectra variables using either the dedicated method or <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code>. Below we specify that all spectra in <code>sps</code> represent centroided data.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps</span><span class="op">$</span><span class="va">centroided</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>

<span class="fu">centroided</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] TRUE TRUE TRUE</code></pre>
<p>The <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> operator can also be used to add arbitrary new spectra variables to a <code>Spectra</code> object. Below we add the SPLASH key to each of the spectra.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps</span><span class="op">$</span><span class="va">splash</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="st">"splash10-00di-0900000000-037d24a7d65676b7e356"</span>,
    <span class="st">"splash10-00di-0900000000-03e99316bd6c098f5d11"</span>,
    <span class="st">"splash10-000i-0900000000-9af60e39c843cb715435"</span><span class="op">)</span></code></pre></div>
<p>This new spectra variable will now be listed as an additional variable in the result of the <code>spectraVariables</code> function and we can directly access its content with <code>sps$splash</code>.</p>
<p>Each spectrum can have a different number of mass peaks, each consisting of a mass-to-charge (m/z) and associated intensity value. These can be extracted with the <code>mz</code> or <code>intensity</code> functions, each of which return a <code>list</code> of <code>numeric</code> values.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mz</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 3
## [[1]] 109.2 124.2 124.5 170.16 170.52
## [[2]] 83.1 96.12 97.14 109.14 124.08 125.1 170.16
## [[3]] 56.0494 69.0447 83.0603 109.0395 110.0712 111.0551 123.0429 138.0662 195.0876</code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">intensity</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 3
## [[1]] 3.407 47.494 3.094 100 13.24
## [[2]] 6.685 4.381 3.022 16.708 100 4.565 40.643
## [[3]] 0.459 2.585 2.446 0.508 8.968 0.524 0.974 100 40.994</code></pre>
<p>Peak data can also be extracted with the <code>peaksData</code> function that returns a list of matrices, each with columns <code>"mz"</code> and <code>"intensity"</code> containing the m/z and intensity values for one spectrum.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hidden_aliases.html">peaksData</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span>
<span class="va">pks</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<pre><code>##          mz intensity
## [1,] 109.20     3.407
## [2,] 124.20    47.494
## [3,] 124.50     3.094
## [4,] 170.16   100.000
## [5,] 170.52    13.240</code></pre>
<p>Note that we would get the same result by using the <code>as</code> method to coerce a <code>Spectra</code> object to a <code>list</code> or <code>SimpleList</code>:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">as</span><span class="op">(</span><span class="va">sps</span>, <span class="st">"SimpleList"</span><span class="op">)</span></code></pre></div>
<pre><code>## List of length 3</code></pre>
<p>The <code>spectraData</code> function returns a <code>DataFrame</code> with the full data for each spectrum (except m/z and intensity values), or with selected spectra variables (which can be specified with the <code>columns</code> parameter). Below we extract the spectra data for variables <code>"msLevel"</code>, <code>"id"</code> and <code>"name"</code>.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">spectraData</span><span class="op">(</span><span class="va">sps</span>, columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"msLevel"</span>, <span class="st">"id"</span>, <span class="st">"name"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## DataFrame with 3 rows and 3 columns
##     msLevel          id              name
##   &lt;integer&gt; &lt;character&gt;       &lt;character&gt;
## 1         2 HMDB0000001 1-Methylhistidine
## 2         2 HMDB0000001 1-Methylhistidine
## 3         2 HMDB0001847          Caffeine</code></pre>
<p><code>Spectra</code> are one-dimensional objects storing spectra, even from different files or samples, in a single list. Specific variables have thus to be used to define the originating file from which they were extracted or the sample in which they were measured. The <em>data origin</em> of each spectrum can be extracted with the <code>dataOrigin</code> function. For <code>sps</code>, the <code>Spectra</code> created from a <code>DataFrame</code>, this will be <code>NA</code> because we did not specify the data origin:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">dataOrigin</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] NA NA NA</code></pre>
<p><code>dataOrigin</code> for <code>sps_sciex</code>, the <code>Spectra</code> which was initialized with data from mzML files, in contrast, returns the originating file names:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="fu">dataOrigin</span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"
## [3] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"
## [5] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"</code></pre>
<p>The current data storage location of a spectrum can be retrieved with the <code>dataStorage</code> variable, which will return an arbitrary string for <code>Spectra</code> that use an in-memory backend or the file where the data is stored for on-disk backends:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">dataStorage</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "&lt;memory&gt;" "&lt;memory&gt;" "&lt;memory&gt;"</code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="fu">dataStorage</span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"
## [3] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"
## [5] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"</code></pre>
</div>
<div id="filtering-subsetting-and-merging" class="section level2">
<h2 class="hasAnchor">
<a href="#filtering-subsetting-and-merging" class="anchor"></a>Filtering, subsetting and merging</h2>
<p>Apart from <em>classical</em> subsetting operations such as <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code> and <code>split</code>, a set of filter functions are defined for <code>Spectra</code> objects (for detailed help please see the <code><a href="../reference/addProcessing.html">?Spectra</a></code> help):</p>
<ul>
<li>
<code>filterAcquisitionNum</code>: retain spectra with certain acquisition numbers.</li>
<li>
<code>filterDataOrigin</code>: subset to spectra from specific origins.</li>
<li>
<code>filterDataStorage</code>: subset to spectra from certain data storage files.</li>
<li>
<code>filterEmptySpectra</code>: remove spectra without mass peaks.</li>
<li>
<code>filterMzRange</code>: subset spectra keeping only peaks with an m/z within the provided m/z range.</li>
<li>
<code>filterMzValues</code>: subset spectra keeping only peaks matching provided m/z value(s).</li>
<li>
<code>filterIsolationWindow</code>: keep spectra with the provided <code>mz</code> in their isolation window (m/z range).</li>
<li>
<code>filterMsLevel</code>: filter by MS level.</li>
<li>
<code>filterPolarity</code>: filter by polarity.</li>
<li>
<code>filterPrecursorMz</code>: retain (MSn) spectra with a precursor m/z within the provided m/z range.</li>
<li>
<code>filterPrecursorScan</code>: retain (parent and children) scans of an acquisition number.</li>
<li>
<code>filterRt</code>: filter based on retention time ranges.</li>
</ul>
<p>In the example below we select all spectra measured in the second mzML file and subsequently filter them to retain spectra measured between 175 and 189 seconds in the measurement run.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu">dataOrigin</span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span><span class="op">)</span>
<span class="va">file_2</span> <span class="op">&lt;-</span> <span class="fu">filterDataOrigin</span><span class="op">(</span><span class="va">sps_sciex</span>, dataOrigin <span class="op">=</span> <span class="va">fls</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">file_2</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 931</code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_sub</span> <span class="op">&lt;-</span> <span class="fu">filterRt</span><span class="op">(</span><span class="va">file_2</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">175</span>, <span class="fl">189</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">sps_sub</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 50</code></pre>
<p>In addition, <code>Spectra</code> support also subsetting with <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code>. Below we perform the filtering above with <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code> -based subsetting.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_sciex</span><span class="op">[</span><span class="va">sps_sciex</span><span class="op">$</span><span class="va">dataOrigin</span> <span class="op">==</span> <span class="va">fls</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&amp;</span>
          <span class="va">sps_sciex</span><span class="op">$</span><span class="va">rtime</span> <span class="op">&gt;=</span> <span class="fl">175</span> <span class="op">&amp;</span>
          <span class="va">sps_sciex</span><span class="op">$</span><span class="va">rtime</span> <span class="op">&lt;=</span> <span class="fl">189</span><span class="op">]</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 50 spectra in a MsBackendMzR backend:
##       msLevel     rtime scanIndex
##     &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1           1   175.212       628
## 2           1   175.491       629
## 3           1   175.770       630
## 4           1   176.049       631
## 5           1   176.328       632
## ...       ...       ...       ...
## 46          1   187.768       673
## 47          1   188.047       674
## 48          1   188.326       675
## 49          1   188.605       676
## 50          1   188.884       677
##  ... 33 more variables/columns.
## 
## file(s):
## 20171016_POOL_POS_3_105-134.mzML</code></pre>
<p>The equivalent using filter function is shown below, with the added benefit that the filtering is recorded in the processing slot.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://magrittr.tidyverse.org">"magrittr"</a></span><span class="op">)</span>
<span class="va">sps_sciex</span> <span class="op">%&gt;%</span>
    <span class="fu">filterDataOrigin</span><span class="op">(</span><span class="va">fls</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">filterRt</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">175</span>, <span class="fl">189</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 50 spectra in a MsBackendMzR backend:
##       msLevel     rtime scanIndex
##     &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1           1   175.212       628
## 2           1   175.491       629
## 3           1   175.770       630
## 4           1   176.049       631
## 5           1   176.328       632
## ...       ...       ...       ...
## 46          1   187.768       673
## 47          1   188.047       674
## 48          1   188.326       675
## 49          1   188.605       676
## 50          1   188.884       677
##  ... 33 more variables/columns.
## 
## file(s):
## 20171016_POOL_POS_3_105-134.mzML
## Processing:
##  Filter: select data origin(s) /__w/_temp/Library/msdata/sciex/20171016_POOL_POS_3_105-134.mzML [Tue Dec  8 14:27:32 2020]
##  Filter: select retention time [175..189] on MS level(s) 1 [Tue Dec  8 14:27:32 2020]</code></pre>
<p>Note that the use of the filter functions might be more efficient for some backends, depending on their implementation, (e.g. database-based backends could <em>translate</em> the filter function into a SQL condition to perform the subsetting already within the database).</p>
<p>Multiple <code>Spectra</code> objects can also be combined into a single <code>Spectra</code> with the <code>c</code> function. The resulting <code>Spectra</code> object will contain an union of the spectra variables of the individual objects. Below we combine the <code>Spectra</code> object <code>sps</code> with an additional object containing another MS2 spectrum for Caffeine.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">caf_df</span> <span class="op">&lt;-</span> <span class="fu">DataFrame</span><span class="op">(</span>msLevel <span class="op">=</span> <span class="fl">2L</span>, name <span class="op">=</span> <span class="st">"Caffeine"</span>,
                    id <span class="op">=</span> <span class="st">"HMDB0001847"</span>,
                    instrument <span class="op">=</span> <span class="st">"Agilent 1200 RRLC; Agilent 6520 QTOF"</span>,
                    splash <span class="op">=</span> <span class="st">"splash10-0002-0900000000-413259091ba7edc46b87"</span>,
                    centroided <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">caf_df</span><span class="op">$</span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">110.0710</span>, <span class="fl">138.0655</span>, <span class="fl">138.1057</span>, <span class="fl">138.1742</span>, <span class="fl">195.9864</span><span class="op">)</span><span class="op">)</span>
<span class="va">caf_df</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.837</span>, <span class="fl">32.341</span>, <span class="fl">0.84</span>, <span class="fl">0.534</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span>

<span class="va">caf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">Spectra</a></span><span class="op">(</span><span class="va">caf_df</span><span class="op">)</span></code></pre></div>
<p>Next we combine the two objects.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sps</span>, <span class="va">caf</span><span class="op">)</span>
<span class="va">sps</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 4 spectra in a MsBackendDataFrame backend:
##     msLevel     rtime scanIndex
##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1         2        NA        NA
## 2         2        NA        NA
## 3         2        NA        NA
## 4         2        NA        NA
##  ... 20 more variables/columns.
## Processing:
##  Merge 2 Spectra into one [Tue Dec  8 14:27:32 2020]</code></pre>
<p>The resulting object contains now the data for all 4 MS2 spectra and an union of all spectra variables from both objects.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">spectraVariables</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1] "msLevel"                 "rtime"                  
##  [3] "acquisitionNum"          "scanIndex"              
##  [5] "dataStorage"             "dataOrigin"             
##  [7] "centroided"              "smoothed"               
##  [9] "polarity"                "precScanNum"            
## [11] "precursorMz"             "precursorIntensity"     
## [13] "precursorCharge"         "collisionEnergy"        
## [15] "isolationWindowLowerMz"  "isolationWindowTargetMz"
## [17] "isolationWindowUpperMz"  "id"                     
## [19] "name"                    "splash"                 
## [21] "instrument"</code></pre>
<p>The second object had an additional spectra variable <em>instrument</em> that was not present in <code>sps</code> and all the spectra in this object will thus get a value of <code>NA</code> for this variable.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps</span><span class="op">$</span><span class="va">instrument</span></code></pre></div>
<pre><code>## [1] NA                                    
## [2] NA                                    
## [3] NA                                    
## [4] "Agilent 1200 RRLC; Agilent 6520 QTOF"</code></pre>
<p>Sometimes not all spectra variables might be required (e.g. also because many of them are empty). This might be specifically interesting also for <code>Spectra</code> containing the data from very large experiments, because it can significantly reduce the object’s size in memory. In such cases the <code>selectSpectraVariables</code> function can be used to retain only specified spectra variables.</p>
</div>
<div id="data-manipulations" class="section level2">
<h2 class="hasAnchor">
<a href="#data-manipulations" class="anchor"></a>Data manipulations</h2>
<p>Some analyses require manipulation of the mass peak data (i.e. the m/z and/or intensity values). One example would be to remove all peaks from a spectrum that have an intensity lower than a certain threshold. Below we perform such an operation with the <code>replaceIntensitiesBelow</code> function to replace peak intensities below 10 in each spectrum in <code>sps</code> with a value of 0.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hidden_aliases.html">replaceIntensitiesBelow</a></span><span class="op">(</span><span class="va">sps</span>, threshold <span class="op">=</span> <span class="fl">10</span>, value <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p>As a result intensities below 10 were set to 0 for all peaks.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">intensity</span><span class="op">(</span><span class="va">sps_rep</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 4
## [[1]] 0 47.494 0 100 13.24
## [[2]] 0 0 0 16.708 100 0 40.643
## [[3]] 0 0 0 0 0 0 0 100 40.994
## [[4]] 0 32.341 0 0 100</code></pre>
<p>Zero-intensity peaks (and peaks with missing intensities) can then be removed with the <code>filterIntensity</code> function specifying a lower required intensity level or optionally also an upper intensity limit.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hidden_aliases.html">filterIntensity</a></span><span class="op">(</span><span class="va">sps_rep</span>, intensity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="cn">Inf</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">intensity</span><span class="op">(</span><span class="va">sps_rep</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 4
## [[1]] 47.494 100 13.24
## [[2]] 16.708 100 40.643
## [[3]] 100 40.994
## [[4]] 32.341 100</code></pre>
<p>The <code>filterIntensity</code> supports also a user-provided function to be passed with parameter <code>intensity</code> which would allow e.g. to remove peaks smaller than the median peak intensity of a spectrum. See examples in the <code><a href="../reference/hidden_aliases.html">?filterIntensity</a></code> help page for details.</p>
<p>Note that any data manipulations on <code>Spectra</code> objects are not immediately applied to the peak data. They are added to a so called <em>processing queue</em> which is applied each time peak data is accessed (with the <code>peaksData</code>, <code>mz</code> or <code>intensity</code> functions). Thanks to this processing queue data manipulation operations are also possible for <em>read-only</em> backends (e.g. mzML-file based backends or database-based backends). The information about the number of such processing steps can be seen below (next to <em>Lazy evaluation queue</em>).</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_rep</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 4 spectra in a MsBackendDataFrame backend:
##     msLevel     rtime scanIndex
##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1         2        NA        NA
## 2         2        NA        NA
## 3         2        NA        NA
## 4         2        NA        NA
##  ... 20 more variables/columns.
## Lazy evaluation queue: 2 processing step(s)
## Processing:
##  Merge 2 Spectra into one [Tue Dec  8 14:27:32 2020]
##  Signal &lt;= 10 in MS level(s) 2 set to 0 [Tue Dec  8 14:27:32 2020]
##  Remove peaks with intensities outside [0.1, Inf] in spectra of MS level(s) 2. [Tue Dec  8 14:27:32 2020]</code></pre>
<p>It is possible to add also custom functions to the processing queue of a <code>Spectra</code> object. Such a function must take a peaks matrix as its first argument, have <code>...</code> in the function definition and must return a peaks matrix (a peaks matrix is a numeric two-column matrix with the first column containing the peaks’ m/z values and the second the corresponding intensities). Below we define a function that divides the intensities of each peak by a value which can be passed with argument <code>y</code>.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Define a function that takes a matrix as input, divides the second</span>
<span class="co">## column by parameter y and returns it. Note that ... is required in</span>
<span class="co">## the function's definition.</span>
<span class="va">divide_intensities</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="va">y</span>
    <span class="va">x</span>
<span class="op">}</span>

<span class="co">## Add the function to the procesing queue</span>
<span class="va">sps_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">addProcessing</a></span><span class="op">(</span><span class="va">sps_rep</span>, <span class="va">divide_intensities</span>, y <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">sps_2</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 4 spectra in a MsBackendDataFrame backend:
##     msLevel     rtime scanIndex
##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1         2        NA        NA
## 2         2        NA        NA
## 3         2        NA        NA
## 4         2        NA        NA
##  ... 20 more variables/columns.
## Lazy evaluation queue: 3 processing step(s)
## Processing:
##  Merge 2 Spectra into one [Tue Dec  8 14:27:32 2020]
##  Signal &lt;= 10 in MS level(s) 2 set to 0 [Tue Dec  8 14:27:32 2020]
##  Remove peaks with intensities outside [0.1, Inf] in spectra of MS level(s) 2. [Tue Dec  8 14:27:32 2020]</code></pre>
<p>Object <code>sps_2</code> has now 3 processing steps in its lazy evaluation queue. Calling <code>intensity</code> on this object will now return intensities that are half of the intensities of the original objects <code>sps</code>.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">intensity</span><span class="op">(</span><span class="va">sps_2</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 4
## [[1]] 23.747 50 6.62
## [[2]] 8.354 50 20.3215
## [[3]] 50 20.497
## [[4]] 16.1705 50</code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">intensity</span><span class="op">(</span><span class="va">sps_rep</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 4
## [[1]] 47.494 100 13.24
## [[2]] 16.708 100 40.643
## [[3]] 100 40.994
## [[4]] 32.341 100</code></pre>
<p>Alternatively we could define a function that returns the maximum peak from each spectrum:</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">max_peak</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
<span class="op">}</span>

<span class="va">sps_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">addProcessing</a></span><span class="op">(</span><span class="va">sps_rep</span>, <span class="va">max_peak</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/lengths.html">lengths</a></span><span class="op">(</span><span class="va">sps_2</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 1 1 1 1</code></pre>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">intensity</span><span class="op">(</span><span class="va">sps_2</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 4
## [[1]] intensity=100
## [[2]] intensity=100
## [[3]] intensity=100
## [[4]] intensity=100</code></pre>
<p>Each spectrum in <code>sps_2</code> thus contains only a single peak. The original data can be <em>restored</em> with the <code>reset</code> function which will empty the lazy evaluation queue and call the <code>reset</code> method on the storage backend. Below we call <code>reset</code> on the <code>sps_2</code> object and hence restore the data to its original state.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_2_rest</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hidden_aliases.html">reset</a></span><span class="op">(</span><span class="va">sps_2</span><span class="op">)</span>

<span class="fu">intensity</span><span class="op">(</span><span class="va">sps_2_rest</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 4
## [[1]] 3.407 47.494 3.094 100 13.24
## [[2]] 6.685 4.381 3.022 16.708 100 4.565 40.643
## [[3]] 0.459 2.585 2.446 0.508 8.968 0.524 0.974 100 40.994
## [[4]] 3.837 32.341 0.84 0.534 100</code></pre>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">intensity</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></code></pre></div>
<pre><code>## NumericList of length 4
## [[1]] 3.407 47.494 3.094 100 13.24
## [[2]] 6.685 4.381 3.022 16.708 100 4.565 40.643
## [[3]] 0.459 2.585 2.446 0.508 8.968 0.524 0.974 100 40.994
## [[4]] 3.837 32.341 0.84 0.534 100</code></pre>
<p>Finally, for <code>Spectra</code> that use a <em>writeable</em> backend, such as the <code>MsBackendDataFrame</code> or <code>MsBackendHdf5Peaks</code>, it is possible to apply the processing queue to the peak data and write that back to the data storage with the <code>applyProcessing</code> function. Below we use this to make all data manipulations on peak data of the <code>sps_rep</code> object persistent.</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">sps_rep</span><span class="op">@</span><span class="va">processingQueue</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 2</code></pre>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">applyProcessing</a></span><span class="op">(</span><span class="va">sps_rep</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">sps_rep</span><span class="op">@</span><span class="va">processingQueue</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_rep</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 4 spectra in a MsBackendDataFrame backend:
##     msLevel     rtime scanIndex
##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1         2        NA        NA
## 2         2        NA        NA
## 3         2        NA        NA
## 4         2        NA        NA
##  ... 20 more variables/columns.
## Processing:
##  Merge 2 Spectra into one [Tue Dec  8 14:27:32 2020]
##  Signal &lt;= 10 in MS level(s) 2 set to 0 [Tue Dec  8 14:27:32 2020]
##  Remove peaks with intensities outside [0.1, Inf] in spectra of MS level(s) 2. [Tue Dec  8 14:27:32 2020]
##  Applied processing queue with 2 steps [Tue Dec  8 14:27:33 2020]</code></pre>
<p>Before <code>applyProcessing</code> the lazy evaluation queue contained 2 processing steps, which were then applied to the peak data and <em>written</em> to the data storage. Note that calling <code>reset</code> <strong>after</strong> <code>applyProcessing</code> can no longer <em>restore</em> the data.</p>
</div>
<div id="comparing-spectra-and-other-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#comparing-spectra-and-other-functions" class="anchor"></a>Comparing spectra and other functions</h2>
<p>Spectra can be compared with the <code>compareSpectra</code> function, that allows to calculate similarities between spectra using a variety of methods. However, peaks from the compared spectra have to be first matched before similarities can be calculated. <code>compareSpectra</code> uses by default the [joinPeaks()] function from the <em><a href="https://bioconductor.org/packages/3.13/MsCoreUtils">MsCoreUtils</a></em> package but supports also other mapping functions to be passed with the <code>MAPFUN</code> parameter (see <code><a href="../reference/joinPeaks.html">?joinPeaks</a></code> man page in <code>MsCoreUtils</code> for more details). The similarity calculation function can be specified with the <code>FUN</code> parameter and defaults to [ndotproduct()], the normalized dot-product. Below we calculate pairwise similarities between all spectra in <code>sps</code> accepting a 50 ppm difference of peaks’ m/z values for being considered matching.</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/hidden_aliases.html">compareSpectra</a></span><span class="op">(</span><span class="va">sps</span>, ppm <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></code></pre></div>
<pre><code>##           [,1]      [,2]      [,3]      [,4]
## [1,] 1.0000000 0.1380817 0.0000000 0.0000000
## [2,] 0.1380817 1.0000000 0.0000000 0.0000000
## [3,] 0.0000000 0.0000000 1.0000000 0.1817149
## [4,] 0.0000000 0.0000000 0.1817149 1.0000000</code></pre>
<p>The resulting matrix represents the result from the pairwise comparison. As expected, the first two and the last two spectra are similar, albeit only moderately while the spectra from 1-Methylhistidine don’t share any similarity with those of Caffeine.</p>
</div>
<div id="plotting-spectra" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting-spectra" class="anchor"></a>Plotting <code>Spectra</code>
</h2>
<p>The <code>Spectra</code> package provides the following functions to visualize spectra data: - <code>plotSpectra</code>: plot each spectrum in <code>Spectra</code> in its own panel. - <code>plotSpectraOverlay</code>: plot multiple spectra into the <strong>same</strong> plot.</p>
<p>Below we use <code>plotSpectra</code> to plot the 4 spectra from the <code>sps</code> object using their names (as provided in spectra variable <code>"name"</code>) as plot titles.</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span>, main <span class="op">=</span> <span class="va">sps</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></code></pre></div>
<p><img src="Spectra_files/figure-html/plotspectra-1.png" width="768"></p>
<p>It is also possible to label individual peaks in each plot. Below we use the m/z value of each peak as its label. In the example we define a function that accesses information from each spectrum (<code>z</code>) and returns a <code>character</code> for each peak with the text that should be used as label. Parameters <code>labelSrt</code>, <code>labelPos</code> and <code>labelOffset</code> define the rotation of the label text and its position relative to the x and y coordinates of the peak.</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span>, main <span class="op">=</span> <span class="va">sps</span><span class="op">$</span><span class="va">name</span>,
            labels <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu">mz</span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,
            labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>, labelPos <span class="op">=</span> <span class="fl">2</span>, labelOffset <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></code></pre></div>
<p><img src="Spectra_files/figure-html/plotspectra-label-1.png" width="768"></p>
<p>These plots are rather busy and for some peaks the m/z values are overplotted. Below we define a <em>label function</em> that will only indicate the m/z of peaks with an intensity higher than 30.</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mzLabel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hidden_aliases.html">peaksData</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span>
    <span class="va">lbls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span>, <span class="st">"mz"</span><span class="op">]</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
    <span class="va">lbls</span><span class="op">[</span><span class="va">z</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">30</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">""</span>
    <span class="va">lbls</span>
<span class="op">}</span>
<span class="fu"><a href="../reference/spectra-plotting.html">plotSpectra</a></span><span class="op">(</span><span class="va">sps</span>, main <span class="op">=</span> <span class="va">sps</span><span class="op">$</span><span class="va">name</span>, labels <span class="op">=</span> <span class="va">mzLabel</span>,
            labelSrt <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>, labelPos <span class="op">=</span> <span class="fl">2</span>, labelOffset <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></code></pre></div>
<p><img src="Spectra_files/figure-html/plotspectra-label-int-1.png" width="768"></p>
<p>Sometimes it might be of interest to plot multiple spectra into the <strong>same</strong> plot (e.g. to directly compare peaks from multiple spectra). This can be done with <code>plotSpectraOverlay</code> which we use below to create an <em>overlay-plot</em> of our 4 example spectra, using a different color for each spectrum.</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#E41A1C80"</span>, <span class="st">"#377EB880"</span>, <span class="st">"#4DAF4A80"</span>, <span class="st">"#984EA380"</span><span class="op">)</span>
<span class="fu"><a href="../reference/spectra-plotting.html">plotSpectraOverlay</a></span><span class="op">(</span><span class="va">sps</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="va">cols</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, col <span class="op">=</span> <span class="va">cols</span>, legend <span class="op">=</span> <span class="va">sps</span><span class="op">$</span><span class="va">name</span>, pch <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></code></pre></div>
<p><img src="Spectra_files/figure-html/plotspectraoverlay-1.png" width="576"></p>
<p>Lastly, <code>plotSpectraMirror</code> allows to plot two spectra against each other as a <em>mirror plot</em> which is ideal to visualize spectra comparison results. Below we plot a spectrum of 1-Methylhistidine against one of Caffeine.</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/spectra-plotting.html">plotSpectraMirror</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sps</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="Spectra_files/figure-html/plotspectramirror-1.png" width="576"></p>
<p>The upper panel shows the spectrum from 1-Methylhistidine, the lower the one of Caffeine. None of the peaks of the two spectra match. Below we plot the two spectra of 1-Methylhistidine and the two of Caffeine against each other matching peaks with a <code>ppm</code> of 50.</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/spectra-plotting.html">plotSpectraMirror</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">sps</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"1-Methylhistidine"</span>, ppm <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>
<span class="fu"><a href="../reference/spectra-plotting.html">plotSpectraMirror</a></span><span class="op">(</span><span class="va">sps</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">sps</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Caffeine"</span>, ppm <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></code></pre></div>
<p><img src="Spectra_files/figure-html/plotspectramirror-ppm-1.png" width="1152"></p>
<p>See also <code><a href="../reference/spectra-plotting.html">?plotSpectra</a></code> for more plotting options and examples.</p>
</div>
<div id="exporting-spectra" class="section level2">
<h2 class="hasAnchor">
<a href="#exporting-spectra" class="anchor"></a>Exporting spectra</h2>
<p>Spectra data can be exported with the <code>export</code> method. This method takes the <code>Spectra</code> that is supposed to be exported and the backend (parameter <code>backend</code>) which should be used to export the data and additional parameters for the export function of this backend. The backend thus defines the format of the exported file. Note however that not all <code>MsBackend</code> classes might support data export. The backend classes currently supporting data export and its format are: - <code>MsBackendMzR</code> (<code>Spectra</code> package): export data in <em>mzML</em> and <em>mzXML</em> format. Can not export all custom, user specified spectra variables. - <code>MsBackendMgf</code> (<a href="https://github.com/RforMassSpectrometry/MsBackendMgf"><code>MsBackendMgf</code></a> package): exports data in <em>Mascot Generic Format</em> (mgf). Exports all spectra variables as individual spectrum fields in the mgf file.</p>
<p>In the example below we use the <code>MsBackendMzR</code> to export all spectra from the variable <code>sps</code> to an mzML file. We thus pass the data, the backend that should be used for the export and the file name of the result file (a temporary file) to the <code>export</code> function (see also the help page of the <code>export,MsBackendMzR</code> function for additional supported parameters).</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="../reference/hidden_aliases.html">export</a></span><span class="op">(</span><span class="va">sps</span>, <span class="fu"><a href="../reference/MsBackend.html">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span>, file <span class="op">=</span> <span class="va">fl</span><span class="op">)</span></code></pre></div>
<pre><code>## Writing file filed9139753801...OK</code></pre>
<p>To evaluate which of the spectra variables were exported, we load the exported data again and identify spectra variables in the original file which could not be exported (because they are not defined variables in the mzML standard).</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_im</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">Spectra</a></span><span class="op">(</span><span class="fu"><a href="../reference/hidden_aliases.html">backendInitialize</a></span><span class="op">(</span><span class="fu"><a href="../reference/MsBackend.html">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">fl</span><span class="op">)</span><span class="op">)</span>
<span class="fu">spectraVariables</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu">spectraVariables</span><span class="op">(</span><span class="va">sps</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu">spectraVariables</span><span class="op">(</span><span class="va">sps_im</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>## [1] "id"         "name"       "splash"     "instrument"</code></pre>
<p>These additional variables were thus not exported. How data export is performed and handled depends also on the used backend. The <code>MsBackendMzR</code> for example exports all spectra by default to a single file (specified with the <code>file</code> parameter), but it allows also to specify for each individual spectrum in the <code>Spectra</code> to which file it should be exported (parameter <code>file</code> has thus to be of length equal to the number of spectra). As an example we export below the spectrum 1 and 3 to one file and spectra 2 and 4 to another.</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/hidden_aliases.html">export</a></span><span class="op">(</span><span class="va">sps</span>, <span class="fu"><a href="../reference/MsBackend.html">MsBackendMzR</a></span><span class="op">(</span><span class="op">)</span>, file <span class="op">=</span> <span class="va">fls</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## Writing file filed91560b8c58...OK
## Writing file filed9116edb5ac...OK</code></pre>
<p>A more realistic use case for mzML export would be to export MS data after processing, such as smoothing (using the <code>smooth</code> function) and centroiding (using the <code>pickPeaks</code> function) of raw profile-mode MS data.</p>
</div>
<div id="changing-backends" class="section level2">
<h2 class="hasAnchor">
<a href="#changing-backends" class="anchor"></a>Changing backends</h2>
<p>In the previous sections we learned already that a <code>Spectra</code> object can use different backends for the actual data handling. It is also possible to change the backend of a <code>Spectra</code> to a different one with the <code>setBackend</code> function. We could for example change the (<code>MsBackendMzR</code>) backend of the <code>sps_sciex</code> object to a <code>MsBackendDataFrame</code> backend to enable use of the data even without the need to keep the original mzML files. Below we change the backend of <code>sps_sciex</code> to the in-memory <code>MsBackendDataFrame</code> backend.</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"Mb"</span><span class="op">)</span></code></pre></div>
<pre><code>## 0.4 Mb</code></pre>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sps_sciex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hidden_aliases.html">setBackend</a></span><span class="op">(</span><span class="va">sps_sciex</span>, <span class="fu"><a href="../reference/MsBackend.html">MsBackendDataFrame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">sps_sciex</span></code></pre></div>
<pre><code>## MSn data (Spectra) with 1862 spectra in a MsBackendDataFrame backend:
##        msLevel     rtime scanIndex
##      &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
## 1            1     0.280         1
## 2            1     0.559         2
## 3            1     0.838         3
## 4            1     1.117         4
## 5            1     1.396         5
## ...        ...       ...       ...
## 1858         1   258.636       927
## 1859         1   258.915       928
## 1860         1   259.194       929
## 1861         1   259.473       930
## 1862         1   259.752       931
##  ... 33 more variables/columns.
## Processing:
##  Switch backend from MsBackendMzR to MsBackendDataFrame [Tue Dec  8 14:27:37 2020]</code></pre>
<p>With the call the full peak data was imported from the original mzML files into the object. This has obviously an impact on the object’s size, which is now much larger than before.</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"Mb"</span><span class="op">)</span></code></pre></div>
<pre><code>## 52.4 Mb</code></pre>
<p>The <code>dataStorage</code> spectrum variable has now changed, while <code>dataOrigin</code> still keeps the information about the originating files:</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">dataStorage</span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "&lt;memory&gt;" "&lt;memory&gt;" "&lt;memory&gt;" "&lt;memory&gt;" "&lt;memory&gt;" "&lt;memory&gt;"</code></pre>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="fu">dataOrigin</span><span class="op">(</span><span class="va">sps_sciex</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"
## [3] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"
## [5] "20171016_POOL_POS_1_105-134.mzML" "20171016_POOL_POS_1_105-134.mzML"</code></pre>
</div>
<div id="parallel-processing-notes" class="section level2">
<h2 class="hasAnchor">
<a href="#parallel-processing-notes" class="anchor"></a>Parallel processing notes</h2>
<p>Most functions on <code>Spectra</code> support (and use) parallel processing out of the box. Peak data access and manipulation methods perform by default parallel processing on a per-file basis (i.e. using the <code>dataStorage</code> variable as splitting factor). <code>Spectra</code> uses <em><a href="https://bioconductor.org/packages/3.13/BiocParallel">BiocParallel</a></em> for parallel processing and all functions use the default registered parallel processing setup of that package.</p>
</div>
</div>
<div id="backends" class="section level1">
<h1 class="hasAnchor">
<a href="#backends" class="anchor"></a>Backends</h1>
<p>Backends allow to use different <em>backends</em> to store mass spectrometry data while providing <em>via</em> the <code>Spectra</code> class a unified interface to use that data. The <code>Spectra</code> package defines a set of example backends but any object extending the base <code>MsBackend</code> class could be used instead. The default backends are:</p>
<ul>
<li><p><code>MsBackendDataFrame</code>: the mass spectrometry data is stored (in-memory) in a <code>DataFrame</code>. Keeping the data in memory guarantees high performance but has also, depending on the number of mass peaks in each spectrum, a much higher memory footprint.</p></li>
<li><p><code>MsBackendMzR</code>: this backend keeps only general spectra variables in memory and relies on the <em><a href="https://bioconductor.org/packages/3.13/mzR">mzR</a></em> package to read mass peaks (m/z and intensity values) from the original MS files on-demand.</p></li>
<li><p><code>MsBackendHdf5Peaks</code>: similar to <code>MsBackendMzR</code> this backend reads peak data only on-demand from disk while all other spectra variables are kept in memory. The peak data are stored in Hdf5 files which guarantees scalability.</p></li>
</ul>
<p>All of the above mentioned backends support changing all of their their spectra variables, <strong>except</strong> the <code>MsBackendMzR</code> that does not support changing m/z or intensity values for the mass peaks.</p>
<p>With the example below we load the data from a single mzML file and use a <code>MsBackendHdf5Peaks</code> backend for data storage. The <code>hdf5path</code> parameter allows us to specify the storage location of the HDF5 file.</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">msdata</span><span class="op">)</span>
<span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/msdata/man/proteomics.html">proteomics</a></span><span class="op">(</span>full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>

<span class="va">sps_tmt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addProcessing.html">Spectra</a></span><span class="op">(</span><span class="va">fl</span>, backend <span class="op">=</span> <span class="fu"><a href="../reference/MsBackend.html">MsBackendHdf5Peaks</a></span><span class="op">(</span><span class="op">)</span>, hdf5path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="fu">dataStorage</span><span class="op">(</span><span class="va">sps_tmt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.h5"
## [2] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.h5"
## [3] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.h5"
## [4] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.h5"
## [5] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.h5"
## [6] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.h5"</code></pre>
</div>
<div id="session-information" class="section level1">
<h1 class="hasAnchor">
<a href="#session-information" class="anchor"></a>Session information</h1>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## R Under development (unstable) (2020-12-04 r79554)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.1 LTS
## 
## Matrix products: default
## BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] parallel  stats4    stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
## [1] msdata_0.31.0       magrittr_2.0.1      Spectra_1.1.10     
## [4] ProtGenerics_1.23.4 BiocParallel_1.25.1 S4Vectors_0.29.5   
## [7] BiocGenerics_0.37.0 BiocStyle_2.19.1   
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.5          compiler_4.1.0      BiocManager_1.30.10
##  [4] rhdf5filters_1.3.2  tools_4.1.0         ncdf4_1.17         
##  [7] digest_0.6.27       evaluate_0.14       memoise_1.1.0      
## [10] rhdf5_2.35.0        rlang_0.4.9         yaml_2.2.1         
## [13] pkgdown_1.6.1.9000  xfun_0.19           stringr_1.4.0      
## [16] knitr_1.30          desc_1.2.0          fs_1.5.0           
## [19] systemfonts_0.3.2   IRanges_2.25.4      MsCoreUtils_1.3.1  
## [22] rprojroot_2.0.2     Biobase_2.51.0      R6_2.5.0           
## [25] textshaping_0.2.1   rmarkdown_2.5       bookdown_0.21      
## [28] Rhdf5lib_1.13.0     mzR_2.25.1          codetools_0.2-18   
## [31] htmltools_0.5.0     MASS_7.3-53         assertthat_0.2.1   
## [34] ragg_0.4.0          stringi_1.5.3       crayon_1.3.4</code></pre>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by RforMassSpectrometry Package Maintainer, Laurent Gatto, Johannes Rainer, Sebastian Gibb.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
